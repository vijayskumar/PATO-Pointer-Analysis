<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
			<html>
				<head>
					<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
					<link rel="stylesheet" href="/nabble.pack.css?v=29" type="text/css" />
	<link rel="stylesheet" href="/template/NamlServlet.jtp?macro=site_style" type="text/css" />
					<script src="/util/jquery-1.7.2.pack.js" type="text/javascript"></script>
	<script src="/util/nabbledropdown-2.4.1.pack.js" type="text/javascript"></script>
	<script src="/template/NamlServlet.jtp?macro=javascript_library&amp;v=102" type="text/javascript"></script>
					<script type="text/javascript">
		var terms = Nabble.getSearchTerms();
		var hasTurnOff = false;
		Nabble.searchHighlight = function($elem) {
			if (terms != null && terms.length > 0) {
				$elem.each(function() {
					Nabble.highlightSearchTerms(terms, this);
				});
				if (Nabble.hasHighlightedTerms && !hasTurnOff) {
					var turnOffLink = '<span id="turn-off-highlight-control"><span class="highlight">&nbsp;X&nbsp;</span> ';
					turnOffLink += '<a href="javascript:void(0)" onclick="Nabble.turnOffHighlight()">Turn off highlighting</a></span>';
					$('#topics-controls-right').prepend(turnOffLink);
					hasTurnOff = true;
				}
			}
		};
		Nabble.turnOffHighlight = function() {
			Nabble.deleteCookie("query");
			Nabble.deleteCookie("searchuser");
			Nabble.deleteCookie("searchterms");
			$('span.search-highlight').removeClass('bold highlight');
			$('#turn-off-highlight-control').hide();
		};
	</script>
	<script type="text/javascript">
		Nabble.messageTextWidth();
	</script>
			<script type="text/javascript"> $(document).ready(function() { Nabble.searchHighlight($('h2.post-subject,div.message-text')); }); </script> <script type="text/javascript"> var _hash = Nabble.hash(); if (_hash) { (function(){ var post = _hash.substr(2); var allPosts = [871799, 872247, 872318, 872322, 872407, 873395, 876406, 876413, 876415, 880647, 880947, 881581]; var allURLs = ["/new-design-of-RecursiveASTVisitor-td871799.html"]; var iPost = allPosts.indexOf(parseInt(post)); var lower = 0; var upper = lower + 20; if (iPost != -1 && (iPost < lower || iPost >= upper)) location.replace(allURLs[Math.floor(iPost/20)]+_hash); })(); } $(document).ready(function() { var rootId = '871799'; var currentPostId = rootId; var isChangingViews = _hash == '#none'; if (_hash && !isChangingViews) currentPostId = _hash.substr(2); Nabble.hideQuotes(); function scrollToSelectedPost() { var $arrow = $('#red-arrow'+currentPostId).show(); if ($arrow.size() > 0) { var isRootPost = currentPostId == rootId; if (Nabble.isEmbedded) { if (Nabble.canScroll()) scrollTo(0, 0); var y = isChangingViews? null : isRootPost? 1 : $arrow.parents('div.classic-row').offset().top; Nabble.resizeFrames('', y); } else if (Nabble.canScroll() && !isRootPost) { var yPos = $arrow.offset().top; scrollTo(0,yPos-20); } } else { if (Nabble.isEmbedded && Nabble.canScroll()) { Nabble.resizeFrames('', 1); } else { var tb = $('div.top-bar').get(0); if (tb) tb.scrollIntoView(); } } }; $(window).load(scrollToSelectedPost); if (Nabble.isEmbedded) { $('div.message-text img').load(Nabble.resizeFrames); } }); </script> <style type="text/css"> div.classic-header { height:2.2em; clear:both; overflow:hidden; } div.classic-author-name { float:left; width: 140px; overflow: hidden; text-align:center; font-weight:bold; } div.classic-subject-line { left:.5em; overflow:hidden; height:1.3em; position:relative; } div.classic-right-menu { float:right; padding-left:1em; } div.classic-bar { padding:.5em .3em; clear:both; height:1.8em; } table.classic-body { border-collapse:collapse; margin-bottom:1em; table-layout: fixed; width:100%; } td.classic-author { vertical-align: top; text-align:center; width:140px; padding-bottom:1em; } td.classic-message { vertical-align:top; padding:1em; } div.message-text { cursor:text; overflow-x:auto; } div.avatar-inner { margin-left:20px; } div.avatar-outer { width:140px; text-align:left; } div.avatar-label { white-space:nowrap; font-size:80%; } </style>

	<title>Clang Developers - new design of RecursiveASTVisitor</title>
			<META NAME="description" CONTENT="new design of RecursiveASTVisitor. Hi, While working on improving the RecursiveASTVisitor class, some of us saw an opportunity for a different design that's cleaner and easier to understand and..."/>
			<META NAME="keywords" CONTENT="new, design, recursiveastvisitor, while, working, improving, class, some, us, saw, opportunity, for, different, s, cleaner, easier, understand, use, here, proposal, comments, clang, developers"/>
			<style type="text/css">
			#search-box-dropdown {
				text-align:left;
				position:absolute;
				display:none;
				z-index:1000;
				overflow:hidden;
			}
		</style>
		<script type="text/javascript">
			$(document).ready(function() {
				var $sdd = $('#search-box-dropdown');
				var $sb = $('#search-input');
				var $form = $sb.parent();
				var timeout;
				$(document).click(function(o){
					var $target = $(o.target);
					if ($target.parents().hasClass('search-box-dropdown')) {
						clearTimeout(timeout);
						$sb.focus();
					}
				});
				$sb.focusin(function(e) {
					$sdd.css('left', $sb.position().left - 5);
					$sdd.width($sb.outerWidth() + 10);
					$sdd.show();
				});
				$sb.focusout(function() {
					timeout = setTimeout(function() {
						$sdd.hide();
					},250);
				});
				$('input[type=radio]', $sdd).change(function() {
					var nodeId = $(this).val();
					$('input[name="node"]', $form).val(nodeId);
				});
				$('input[name="node"]', $form).val(42468);
			});
		</script><script type="text/javascript">
			Nabble.setView = function(view,url,post) {
				Nabble.setVar("tview",view);
				url += Nabble.getClientID(';');
				if (url.indexOf('#') == -1)
					url += '#none';
				location.replace(url);
			};
		</script><style type="text/css"> div.nabble-tooltip, div.nabble-tooltip * { color: #EEE; font-weight:bold; } div.nabble-tooltip { background: #000; font-size:90%; line-height:normal; display: none; position: absolute; z-index: 88888; padding: .5em; border: 1px solid #FFF; white-space:normal; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; } div.nabble-tooltip-small-row, div.nabble-tooltip-small-row * { color:#D0EAF2; } div.nabble-tooltip-small-row { font-size:80%; font-weight:normal; padding-top: .4em; } div.nabble-tooltip-arrow { font: 40px Arial, Sans-serif; line-height:1em; left:15px; position:absolute; bottom:-15px; height:15px; width:30px; overflow:hidden; } div.nabble-tooltip-arrow div { position:absolute; } div.nabble-tooltip-arrow div.d1 { top:-22px; color: #FFF; } div.nabble-tooltip-arrow div.d2 { top:-25px; color: #000; } </style> <script type="text/javascript"> Nabble.startTooltip = function(e, position, delay) { if (e.nabbletooltip) return; e.nabbletooltip = true; var $this = $(e); var $arrow = $this.children().last(); var $elem = $this.prev(); $elem.hover( function() { setTip(); setTimer(); }, function() { stopTimer(); $this.hide(); } ); function setTimer() { $this.showTipTimer = setTimeout(function() { $('div.nabble-tooltip').hide(); stopTimer(); $this.fadeTo('fast', .8); }, delay); }; function stopTimer() { clearInterval($this.showTipTimer); }; function setTip(){ if ($this.parent().get() != document.body) $(document.body).append($this); var useTitle = $this.attr('use_title') == 'true'; if (useTitle) { var title = $elem.attr('title'); if (title != '') { $arrow.remove(); $this.html(title); $elem.attr('title',''); $this.append($arrow); } } var win = $(window).width(); if (position == 'up') { var w = $this.outerWidth(); if (w > 250) { w = 250; $this.width(w); } var xMid = $elem.offset().left + $elem.outerWidth()/2; var xTip = xMid - w/2; if (xTip+w > win-5) xTip = win-w-5; if (xTip < 0) xTip = 0; var xArrow = xMid-xTip-11; var yTip = $elem.offset().top-$this.outerHeight()-12; $arrow.css('left', xArrow); $this.css({'top' : yTip, 'left' : xTip}); } else if (position == 'right') { var h = $this.outerHeight(); var yMid = $elem.offset().top + $elem.outerHeight()/2; var yTip = yMid - h/2; var xTip = $elem.offset().left + $elem.outerWidth() + 10; $arrow.width(8).height(24).css({bottom:0,left:-8}); var yArrow = (h - 24)/2; $arrow.css({top:yArrow}); var $d1 = $arrow.children().first(); var $d2 = $arrow.children().last(); $d1.css({top:-11}); $d2.css({top:-11,left:1}); $this.css({'top' : yTip, 'left' : xTip}); } }; }; </script><script type="text/javascript">
			Nabble.pinTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=pin_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#pin-icon').show();
					NabbleDropdown.show('unpinTopic');
					NabbleDropdown.hide('pinTopic');
					alert('This topic has been pinned.');
				});
			};
		</script><script type="text/javascript">
			Nabble.unpinTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=unpin_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#pin-icon').hide();
					NabbleDropdown.hide('unpinTopic');
					NabbleDropdown.show('pinTopic');
					alert('This topic has been unpinned.');
				});
			};
		</script><script type="text/javascript">
			Nabble.lockTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=lock_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#lock-icon').show();
					NabbleDropdown.show('unlockTopic');
					NabbleDropdown.hide('lockTopic');
					alert('This topic has been locked.');
				});
			};
		</script><script type="text/javascript">
			Nabble.unlockTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=unlock_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#lock-icon').hide();
					NabbleDropdown.hide('unlockTopic');
					NabbleDropdown.show('lockTopic');
					alert('This topic has been unlocked.');
				});
			};
		</script><script type="text/javascript" src="http://www.adbayes.com/LoadUnit.jtp?c=1"></script>
			<script type="text/javascript">
				Nabble.adbayes();
			</script><script type="text/javascript">
			Nabble.nViews = function(id, views) {
				var $v = $('#v'+id);
				var pos = views=='1'?0:1;
				var t = $v.html()? $v.html().split('|')[pos]:'';
				$v.html(t == ''? views : t.replace(/%1/g,views)).show();
			};
		</script><style type="text/css">
			img.report-flag {
				vertical-align:middle;
				cursor: pointer;
			}
			#report-inappropriate-content {
				position: fixed;
				z-index:9999;
				display:none;
				padding:1.5em;
				left:8%;
				right:8%;
				top:8%;
				background-color:#555;
			}
			#report-inappropriate-content-inner { padding:.5em; }
			#report-inappropriate-content-inner div.big {
				height:5em;
				padding-top:2em;
				text-align:center;
				font-size:250%;
			}
			#report-inappropriate-content-inner div.big2 { font-size:70%; }
			div.inappropriate-option { margin:.5em 0; }
		</style>
		<script type="text/javascript">
			var reportNodeId = null;
			Nabble.reportContent = function(nodeId) {
				reportNodeId = nodeId;
				$('#report-inappropriate-content').show();
				var url = '/template/NamlServlet.jtp?macro=report_inappropriate_content_form';
				$.get(url, function(data) {
					$('#report-inappropriate-content-inner').html(data);
				});
			}
			Nabble.closeReport = function() {
				$('#report-inappropriate-content').hide();
			}
			Nabble.sendReport = function() {
				$('#send-report-button').attr('disabled','true').addClass('toolbar-disabled');
				var type = $('input[name=report_type]:checked').val();
				var url = '/template/NamlServlet.jtp?macro=report_inappropriate_content_submit&node='+reportNodeId+'&type='+type+Nabble.getClientID();
				$.get(url, function(data) {
					var h = 'Thank You';
					h += '<div class="weak-color big2">We will review your report soon.</div>';
					h += '<a href="javascript: void Nabble.closeReport()">Close</a>';
					$('#report-inappropriate-content-inner').html('<div class="big">'+h+'</div>');
				});
			}
		</script>
					<script type="text/javascript">
		Nabble.setFontSize();
		
	</script>
	<script type="text/javascript">
		if (Nabble.analytics) Nabble.analytics();
	</script>
	<!-- Start Quantcast tag -->
	<script type="text/javascript">
		_qoptions={ qacct:"p-34EL1DZyJypTI" };
	</script>
	<script type="text/javascript" src="http://edge.quantserve.com/quant.js"></script>
	<noscript>
		<a href="http://www.quantcast.com/p-34EL1DZyJypTI" target="_blank" rel="nofollow">
			<img src="http://pixel.quantserve.com/pixel/p-34EL1DZyJypTI.gif" style="display: none;" border="0" height="1" width="1" alt="Quantcast"/>
		</a>
	</noscript>
	<!-- End Quantcast tag -->
	<!-- Start Google Analytics -->
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['nabble._setAccount', 'UA-91855-9']);
		_gaq.push(['nabble._trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
	<!-- End Google Analytics -->
	<script type="text/javascript">
		var site_admins = [8052];
	</script>
	<script type="text/javascript">
		var isSafe = true;
		var Ads = Ads || {};
		Ads.text = {
			daysLeft: 'Trial period ends in $1 day(s)',
			removeAds: 'Remove Ads',
			buyCredits: 'Upgrade'
		};
		$(document).ready(function() {
			if (Nabble.wasCreatedRecently && Nabble.currentCredits == 0 && isSafe) {
				var s = '<div class="weak-color" style="text-align:center;margin:1em;font-size:80%">';
				s += Ads.text.daysLeft.replace(/\$1/,daysLeft)+' &ndash; ';
				s += '<a href="/template/NamlServlet.jtp?macro=site_payment">'+(Nabble.isSafe?Ads.text.removeAds:Ads.text.buyCredits)+'</a>';
				s += '</div>';
				var isAdmin = Nabble.userId && site_admins.indexOf(Number(Nabble.userId)) >= 0;
				isAdmin && $('div.nabble').append(s);
			}
		});
	</script>
	<script type="text/javascript">
		$(document).ready(function() {
			if (Nabble.userId && site_admins.indexOf(Number(Nabble.userId)) >= 0)
				$('div.no-ads-message').show();
		});
	</script>
				</head>
				<body>
					<div id="notice" class="notice rounded-bottom"></div>
					<div class="nabble macro_classic_forum_topic" id="nabble">
						
			
			<div class="top-bar">
		<div class="breadcrumbs" style="float:left">
			<span id="breadcrumbs" class="weak-color">
		
				<a href="http://clang-developers.42468.n3.nabble.com/">Clang Developers</a>
	</span>
		</div>
		<div style="text-align:right;">
			<span style="white-space:nowrap;" id="nabble-user-header"></span>
	<script type="text/javascript">Nabble.userHeader();</script>
		</div>
	</div>
			
			<div id="nabble-newsflash" class="info-message" style="display:none;padding:.5em;margin-bottom:.5em"></div>
	
			<div id="topic-search-box" class="search-box float-right" style="padding:.5em 0">
		<form action="/template/NamlServlet.jtp">
		<input type="hidden" name="macro" value="search_page" />
		<input type="hidden" name="node" value="871799" />
		
		
		
		<input id="search-input" name="query" size="18" class="medium-border-color"/>
		<div id="search-box-dropdown" class="search-box-dropdown light-bg-color drop-shadow border1 medium-border-color rounded-bottom">
		<div style="margin:.5em .5em 0 .5em">
					<b>Search</b><br/>
					<input id="search-root-node" type="radio" name="n" value="42468" checked="true"/>
					<label for="search-root-node">everywhere</label><br/>

					<input id="search-this-node" type="radio" name="n" value="871799"/>
					<label for="search-this-node">
						only in this topic
					</label>
				</div>
		<div style="margin:.5em;line-height:2em">
			<input class="toolbar action-button float-right" type="submit" value="Search"/>
			<a href="/template/NamlServlet.jtp?macro=adv_search_page&amp;node=871799" rel="nofollow" style="font-size:80%">Advanced Search</a>
		</div>
	</div>
	</form>
	</div>

	<h1 id="post-title" class="adbayes-content" style="margin:0.25em 0 .8em">
		new design of RecursiveASTVisitor
	</h1>
			<div style="margin:1.2em 0 5em">
		<div id="topics-controls-left" class="float-left nowrap">
			<table>
		<tr>
			<td style="padding-right:.1em">
		<img src="/images/view-classic.gif" width="18" height="18" style="border:none" alt="classic"/>
	</td>

	<td style="padding-right:1.1em">
		Classic
	</td>

			<td style="padding-right:.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView('list', '/new-design-of-RecursiveASTVisitor-tc871799.html',null)"><img src="/images/view-list.gif" width="18" height="18" style="border:none" alt="list"/></a>
	</td>

	<td style="padding-right:1.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView('list', '/new-design-of-RecursiveASTVisitor-tc871799.html',null)">List</a>
	</td>

			<td style="padding-right:.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html',null)"><img src="/images/view-threaded.gif" width="18" height="18" style="border:none" alt="threaded"/></a>
	</td>

	<td style="padding-right:1.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html',null)">Threaded</a>
	</td>
		</tr>
	</table>
		</div>
		<div id="topics-controls-right" class="float-right nowrap" style="padding-top:.3em">
			<span style="padding-right:1em;height:21px">
		<img id="pin-icon" src="/images/pin.png" width="20" height="21" title="This topic has been pinned in Clang Developers." style="vertical-align:middle;display:none;"/>
		<div id="tooltip96682" class="nabble-tooltip" use_title="true">
		
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip96682'), 'up', 400);
	</script>
	</span>
	<span id="lock-icon" class="weak-color" style="padding:0 .5em;margin-right:.5em;display:none;">
		<img src="/images/lock_sm.png" width="10" height="15" style="vertical-align:middle"/> Locked
	</span>
	<span style="padding-right:1em">
		12 messages
	</span>
	<img src="/images/gear.png" class="image16" alt="Options"/>
	<span id="dd_topicdropdown"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("topicdropdown", "Options","Click for more options");
		
		dropdown.add('topicSubscriptionLink', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dsubscribe&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3ESubscribe via email\x3C/a\x3E');
		dropdown.addSeparator();
		dropdown.add('moveTopic', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3EMove topic\x3C/a\x3E', 'display:none');
		dropdown.add('pinTopic', '\x3Ca href\x3D\"javascript: void Nabble.pinTopic(871799)\" rel\x3D\"nofollow\"\x3EPin topic\x3C/a\x3E', 'display:none');
		dropdown.add('unpinTopic', '\x3Ca href\x3D\"javascript: void Nabble.unpinTopic(871799)\" rel\x3D\"nofollow\"\x3EUnpin topic\x3C/a\x3E', 'display:none');
		dropdown.add('lockTopic', '\x3Ca href\x3D\"javascript: void Nabble.lockTopic(871799)\" rel\x3D\"nofollow\"\x3ELock topic\x3C/a\x3E', 'display:none');
		dropdown.add('unlockTopic', '\x3Ca href\x3D\"javascript: void Nabble.unlockTopic(871799)\" rel\x3D\"nofollow\"\x3EUnlock topic\x3C/a\x3E', 'display:none');
		dropdown.add('deleteRecursively', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(871799)\" rel\x3D\"nofollow\"\x3EDelete this topic\x3C/a\x3E', 'display:none');
			dropdown.add('deletePost', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(871799)\" rel\x3D\"nofollow\"\x3EDelete this topic\x3C/a\x3E', 'display:none');
		dropdown.add('changeMetaTags', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_title_and_meta_tags&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3EChange title and meta tags\x3C/a\x3E', 'display:none');
		dropdown.add('embedPost871799', '\x3Ca href\x3D\"/embed/EmbedOptions.jtp?node\x3D871799\" rel\x3D\"nofollow\"\x3EEmbed post\x3C/a\x3E');
		dropdown.add('permalink871799', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.build('dd_topicdropdown');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=topic_dropdown_later&node=871799' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
		</div>
	</div>
			<div id="topic-contents" style="margin-top:1em;clear:both">
		<div id="classic-contents">
		
		<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960">Zhanyong Wan (λx.x x)</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=871799" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html',871799)">Threaded</a>
	<div id="tooltip94842" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip94842'), 'up', 400);
	</script> |
					<span id="dd_postdropdown871799"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown871799", "More","Click for more options");
		
		dropdown.add('replyToAuthor871799', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D871799\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost871799', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost871799', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost871799', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(871799)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively871799', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(871799)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate871799', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print871799', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink871799', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail871799', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D871799\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown871799');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=871799' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(871799)"/>
	<div id="tooltip25853" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip25853'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow871799" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275694537000-7"></span><script type="text/javascript">
		Nabble.get('d1275694537000-7').innerHTML= Nabble.formatDateLong(new Date(1275694537000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960" rel="nofollow" title="View profile of Zhanyong Wan (λx.x x)" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/77efdc542a2e6f7a356c42031ed41a9f?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Zhanyong Wan (λx.x x)" title="Zhanyong Wan (λx.x x)"/><img src="/images/online.png" class="online12960 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count12960 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message871799" class="message-text adbayes-content">
		Hi,<br><br>While working on improving the RecursiveASTVisitor class, some of us saw an opportunity for a different design that&#39;s cleaner and easier to understand and use.  Here&#39;s the proposal.  Comments and suggestions welcome!<br>

<h1>Clang AST Visitor Design </h1>
<p>
This document discusses the design of a customizable visitor class for
the AST generated by the Clang C++ parser.
</p><p>
</p><h2><a name="Background" target="_top" rel="nofollow" link="external"> </a> Background </h2>
<p>
Clang comes with two AST visitor classes:
ASTVisitor
and
RecursiveASTVisitor.
The ideas behind the two are similar.  Both are implemented using the
CRTP pattern.  The former is considered an internal class and not for
use in tools developed on top of Clang.  The latter is supposed to be
a public API.
</p><p>
At this time, neither class is complete (i.e. they&#39;ll miss some AST
nodes) and there are known bugs (e.g. some AST nodes may be visited
more than once).  We are working on improving <code>RecursiveASTVisitor</code>.
Our experience shows that its design has much space for improvement.  Therefore it
would be a worthwhile exercise to see what we can come up with if we
do it from scratch, without being constrained or influenced by the
current <code>RecursiveASTVisitor</code> design.
</p><p>
</p><h2><a name="Concepts_and_Terminology" target="_top" rel="nofollow" link="external"> </a> Concepts and Terminology </h2>
<p>
Muddy concepts lead to poor, confusing designs.  Before we explore the
design space, it&#39;s important to clarify some key concepts.
</p><p>
</p><ul><li> An <strong>AST</strong> is a tree-shaped data structure.  A node in an AST can
     have 0 or many other nodes as its children.
</li><li> There a <em>three categories</em> of AST nodes in Clang: statements,
     declarations/definitions, and types.  They are derived from class
     Stmt,
     Decl,
     and
     TypeLoc,
     respectively.  In general, a node may have children of any or all
     of the three categories.  The class hierarchies for <code>Stmt</code>,
     <code>Decl</code>, and <code>TypeLoc</code> can be found
     <a href="http://clang.llvm.org/doxygen/hierarchy.html" target="_top" rel="nofollow" link="external">here</a>.
</li><li> The AST visitor has <em>three</em> distinct tasks:
<ol><li> traverse the entire AST (i.e. go to every node),
</li><li> at each node, walk up the class hierarchy, starting with the
         dynamic type of the node,
</li><li> for a given (node, type) combination (where &#39;type&#39; is some
         base class of the dynamic type of &#39;node&#39;), call a
         user-overridable function to actually &quot;visit&quot; the node.
</li></ol>
</li></ul>
<p>
</p><h2><a name="Design_Goals" target="_top" rel="nofollow" link="external"> </a> Design Goals </h2>
<p>
</p><ul><li> easy-to-understand API
</li><li> performs a <a href="http://www.google.com/url?sa=D&amp;q=http%3A%2F%2Fen.wikipedia.org%2Fwiki%2FTree_traversal%23Depth-first_Traversal" target="_top" rel="nofollow" link="external">depth-first</a>, preorder traversal on the AST (no child of a node can be visited until all work on the node has been done)
</li><li> complete coverage: each node in the AST must be visited
</li><li> no duplication: a node cannot be visited more than once
</li><li> common use cases should be easy
</li><li> fast
</li></ul>
<p>
</p><h2><a name="Our_Design" target="_top" rel="nofollow" link="external"> </a> Our Design </h2>
<p>
The distinction between the AST visitor&#39;s three tasks (see the
&quot;Concepts and Terminology&quot; section above) is important for
understanding how the AST visitor works and using it effectively.
Therefore we use naming conventions to highlight the role of a method
of the AST visitor:
</p><p>
</p><ul><li> <code>TraverseFoo(Foo* x)</code> does task #1.  It traveses
     (i.e. recursively visits) the sub-tree rooted at <code>x</code>, where <code>Foo</code>
     is <code>*x</code>&#39;s dynamic type (it&#39;s the caller&#39;s responsibility to
     ensure the correct type).
</li><li> <code>Traverse(Decl* x)</code> simply dispatches (i.e. forwards) to
     <code>TraverseFoo(Foo* x)</code> where <code>Foo</code> is the dynamic type of <code>*x</code>.
     <code>Traverse(Stmt* x)</code> and <code>Traverse(TypeLoc* x)</code> work similarly.
</li><li> <code>WalkUpFromFoo(Foo* x)</code> (better name welcome) does task #2.  It
     does not try to visit any child of <code>x</code>.  Instead, it first calls
     <code>WalkUpFromBar(x)</code> where <code>Bar</code> is the direct parent class of <code>Foo</code>
     (unless <code>Foo</code> has no parent), and then calls <code>VisitFoo(x)</code> (see the
     next bullet).
</li><li> <code>VisitFoo(Foo* x)</code> does task #3.
</li></ul>
<p>
Here&#39;s some pesudo code to show what these methods&#39; implementation
looks like:
</p><p>
</p><pre class="prettyprint"><span class="com">// A function returns false if it wants the traversal to abort (note that<br>// the current RecursiveASTVisitor class returns true for abortion - we<br>// feel that &#39;false&#39; is much more intuitive).</span><span class="pln"><br>

</span><span class="com">// Therefore, each caller needs to check the return code and propagate</span><span class="pln"><br></span><span class="com">// it up appropriately.  Such plumbing code is omitted here for clarify.</span><span class="pln"><br>

<br></span><span class="com">// The entry point for visiting an AST rooted at x.</span><span class="pln"><br></span><span class="kwd">bool</span><span class="pln"> </span><span class="typ">Traverse</span><span class="pun">(</span><span class="typ">Decl</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="kwd">switch</span><span class="pun">(</span><span class="pln">x</span><span class="pun">-</span>&gt;<span class="pln">getKind</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="kwd">case</span><span class="pln"> kFoo</span><span class="pun">:</span><span class="pln"><br>    </span><span class="typ">TraverseFoo</span><span class="pun">((</span><span class="typ">Foo</span><span class="pun">*)</span><span class="pln">x</span><span class="pun">);</span><span class="pln"><br>

    </span><span class="kwd">break</span><span class="pun">;</span><span class="pln"><br>  </span><span class="kwd">case</span><span class="pln"> kBar</span><span class="pun">:</span><span class="pln"><br>    </span><span class="typ">TraverseBar</span><span class="pun">((</span><span class="typ">Bar</span><span class="pun">*)</span><span class="pln">x</span><span class="pun">);</span><span class="pln"><br>

    </span><span class="kwd">break</span><span class="pun">;</span><span class="pln"><br>  </span><span class="pun">...</span><span class="pln"><br>  </span><span class="pun">}</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br>

<br></span><span class="kwd">bool</span><span class="pln"> </span><span class="typ">TraverseFoo</span><span class="pun">(</span><span class="typ">Foo</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="typ">WalkUpFromFoo</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln"><br>  </span><span class="kwd">for</span><span class="pln"> each child node n of x </span><span class="pun">{</span><span class="pln"><br>

    </span><span class="typ">Traverse</span><span class="pun">(</span><span class="pln">n</span><span class="pun">)</span><span class="pln"><br>  </span><span class="pun">}</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br>

<br></span><span class="kwd">bool</span><span class="pln"> </span><span class="typ">WalkUpFromFoo</span><span class="pun">(</span><span class="typ">Foo</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="typ">WalkUpFromBar</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln">  </span><span class="com">// Bar is Foo&#39;s parent.</span><span class="pln"><br>

  </span><span class="typ">VisitFoo</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">bool</span><span class="pln"> </span><span class="typ">WalkUpFromDecl</span><span class="pun">(</span><span class="typ">Decl</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="com">// Decl has no parent, so no more walking up.</span><span class="pln"><br>  </span><span class="typ">VisitDecl</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln"><br>

</span><span class="pun">}</span><span class="pln"><br><br></span><span class="com">// All Visit*() methods do nothing by default.</span><span class="pln"><br></span><span class="kwd">bool</span><span class="pln"> </span><span class="typ">VisitFoo</span><span class="pun">(</span><span class="typ">Foo</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln"> </span><span class="pun">}</span></pre>


<p>
Usually, a user shouldn&#39;t override a <code>Traverse*()</code> or <code>WalkUpFrom*()</code>
function - they are the &quot;skeleton&quot; of the AST visitor and do the
mundane plumbing that a normal user is not interested in.  We
recommend that only people truly understand how the traversal works
can override them.
</p><p>
A user is expected to override the <code>Visit*()</code> methods as needed.  The
default implementation of them does nothing.
</p><p>
Returning a <code>bool</code> to indicate whether the traversal needs to be
aborted requires much tedious, error-prone plumbing in the
implementation.  Exceptions are the most natural solution here, but
unfortunately they are banned from Clang code.
</p><p>One advantage of this design over the existing <code>RecursiveASTVisitor</code>  is that when a user overrides <code>VisitFoo()</code>, he only
needs to do what he&#39;s interested in, without worrying about calling
<code>VisitFoo()</code> or any other methods in the base AST visitor class (so
less chance to shoot his own feet).</p><p>With this design, all Visit*() methods on an AST ndoe are called before any Visit*() method is called on a child node of it.  So the trace of the Visit*() calls is easy to understand and reason about.<br>

</p><p>
One thing people might not like about the design is that it uses more
methods.  I actually think it&#39;s a good thing that we have separate
families of methods for separate roles.  <code>RecursiveASTVisitor</code>&#39;s
approach of lumping all logic (traversal, walking up the type
hierarchy, and the custom visiting logic) in the same <code>Visit*()</code>
method makes the implementation more tricky and error-prone - that&#39;s
probably why there was so much confusion when we were trying to
improve <code>RecursiveASTVisitor</code>.
</p><p>
To ensure performance, we would use CRTP as the existing AST visitors
do.  That means two things:
</p><p>
</p><ol><li> No need for virtual functions.
</li><li> The entire code is templated s.t. the compiler can easily inline
      trivial functions and do cross-function optimization.
</li></ol>
<p>
</p><h2><a name="Use_Cases" target="_top" rel="nofollow" link="external"> </a> Use Cases </h2>
<p>
Let&#39;s see how some typical use cases can be implemented using our AST
visitor.
</p><p>
</p><h3><a name="Dump_the_AST" target="_top" rel="nofollow" link="external"> </a> Dump the AST </h3>
<p>
Only 3 methods need to be overridden:
</p><p>
</p><pre class="prettyprint"><span class="typ">VisitDecl</span><span class="pun">(</span><span class="typ">Decl</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="kwd">print</span><span class="pln"> information about x</span><span class="pun">;</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="typ">VisitStmt</span><span class="pun">(</span><span class="typ">Stmt</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="kwd">print</span><span class="pln"> information about x</span><span class="pun">;</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="typ">VisitTypeLoc</span><span class="pun">(</span><span class="typ">TypeLoc</span><span class="pun">*</span><span class="pln"> x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="kwd">print</span><span class="pln"> information about x</span><span class="pun">;</span><span class="pln"><br></span><span class="pun">}</span></pre>
<p>
</p><h3>Search for an AST Node of Type Foo </h3>
<p>
The tool would override <code>VisitFoo(Foo* x)</code> to return false if x is the
node it&#39;s looking for.
</p><p>
</p><h3><a name="Find_the_Parents_of_an_AST_Node" target="_top" rel="nofollow" link="external"> </a> Find the Parents of an AST Node </h3>
<p>
The tool would maintain a stack of the nodes that lead to the current
node.  It can build the stack by overriding exactly 3 methods
(plumbing of the return code omitted):
</p><p>
</p><pre class="prettyprint"><span class="typ">Traverse</span><span class="pun">(</span><span class="typ">Decl</span><span class="pun">*</span><span class="pln"> d</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="typ">Push</span><span class="pun">(</span><span class="pln">d</span><span class="pun">);</span><span class="pln"><br>  </span><span class="typ">Base</span><span class="pun">::</span><span class="typ">Traverse</span><span class="pun">(</span><span class="pln">d</span><span class="pun">);</span><span class="pln"><br>

  </span><span class="typ">Pop</span><span class="pun">();</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="typ">Traverse</span><span class="pun">(</span><span class="typ">Stmt</span><span class="pun">*</span><span class="pln"> s</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="typ">Push</span><span class="pun">(</span><span class="pln">s</span><span class="pun">);</span><span class="pln"><br>  </span><span class="typ">Base</span><span class="pun">::</span><span class="typ">Traverse</span><span class="pun">(</span><span class="pln">s</span><span class="pun">);</span><span class="pln"><br>

  </span><span class="typ">Pop</span><span class="pun">();</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="typ">Traverse</span><span class="pun">(</span><span class="typ">TypeLoc</span><span class="pun">*</span><span class="pln"> t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>

  </span><span class="typ">Push</span><span class="pun">(</span><span class="pln">t</span><span class="pun">);</span><span class="pln"><br>  </span><span class="typ">Base</span><span class="pun">::</span><span class="typ">Traverse</span><span class="pun">(</span><span class="pln">t</span><span class="pun">);</span><span class="pln"><br>

  </span><span class="typ">Pop</span><span class="pun">();</span><span class="pln"><br></span><span class="pun">}</span></pre><br>-- <br>Zhanyong<br><br>
<br />_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=871799&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	<script type="text/javascript">
				Nabble.ads('first_classic_message');
			</script>
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=14308">Abramo Bagnara-2</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=872247" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a872247',872247)">Threaded</a>
	<div id="tooltip26819" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip26819'), 'up', 400);
	</script> |
					<span id="dd_postdropdown872247"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown872247", "More","Click for more options");
		
		dropdown.add('replyToAuthor872247', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D872247\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost872247', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D872247\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost872247', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D872247\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost872247', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(872247)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively872247', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(872247)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate872247', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D872247\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print872247', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D872247\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink872247', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p872247.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail872247', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D872247\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown872247');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=872247' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(872247)"/>
	<div id="tooltip26892" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip26892'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow872247" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275721285000-437"></span><script type="text/javascript">
		Nabble.get('d1275721285000-437').innerHTML= Nabble.formatDateLong(new Date(1275721285000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=14308" rel="nofollow" title="View profile of Abramo Bagnara-2" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/4368dd8fb7dddc53e260d73e6d681ee5?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Abramo Bagnara-2" title="Abramo Bagnara-2"/><img src="/images/online.png" class="online14308 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count14308 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message872247" class="message-text adbayes-content">
		<br/>For proper implementation of tree finite automata I'd suggest you to
<br/>consider the (needed) distinction from node entering and node exiting.
<br/><br/>&nbsp; call Enter node handler;
<br/>&nbsp; visit node childs;
<br/>&nbsp; call Exit Node handler;
<br/><br/>Another very useful thing you should consider is to add a child
<br/>identifier to handler arguments that inform handler about *which* parent
<br/>child is currently visited: this information is not otherwise deducible.
<br/><br/>To better understand this try to imagine an application that want to
<br/>check lhs of assign binary operator.
<br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=872247&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960">Zhanyong Wan (λx.x x)</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=872318" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a872318',872318)">Threaded</a>
	<div id="tooltip25493" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip25493'), 'up', 400);
	</script> |
					<span id="dd_postdropdown872318"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown872318", "More","Click for more options");
		
		dropdown.add('replyToAuthor872318', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D872318\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost872318', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D872318\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost872318', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D872318\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost872318', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(872318)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively872318', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(872318)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate872318', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D872318\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print872318', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D872318\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink872318', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p872318.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail872318', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D872318\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown872318');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=872318' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(872318)"/>
	<div id="tooltip82432" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip82432'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow872318" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275722002000-625"></span><script type="text/javascript">
		Nabble.get('d1275722002000-625').innerHTML= Nabble.formatDateLong(new Date(1275722002000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960" rel="nofollow" title="View profile of Zhanyong Wan (λx.x x)" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/77efdc542a2e6f7a356c42031ed41a9f?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Zhanyong Wan (λx.x x)" title="Zhanyong Wan (λx.x x)"/><img src="/images/online.png" class="online12960 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count12960 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message872318" class="message-text adbayes-content">
		Thanks for the comments.
<br/><br/>On Sat, Jun 5, 2010 at 12:01 AM, Abramo Bagnara
<br/>&lt;<a href="/user/SendEmail.jtp?type=node&node=872318&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt; wrote:
<br/>&gt;
<br/>&gt; For proper implementation of tree finite automata I'd suggest you to
<br/>&gt; consider the (needed) distinction from node entering and node exiting.
<br/>&gt;
<br/>&gt;  call Enter node handler;
<br/>&gt;  visit node childs;
<br/>&gt;  call Exit Node handler;
<br/><br/>This is beyond the scope of what I'd like to do now. &nbsp;The generality
<br/>you proposed can be useful (e.g. for implementing postorder
<br/>traversal), but all the use cases I have in mind only need preorder
<br/>traversal (as stated in my design goal). &nbsp;Note that the &quot;exit node
<br/>handler&quot; can always be added later without breaking existing clients,
<br/>so we can incorporate your proposal later, when there's actual need
<br/>for it.
<br/><br/>&gt; Another very useful thing you should consider is to add a child
<br/>&gt; identifier to handler arguments that inform handler about *which* parent
<br/>&gt; child is currently visited: this information is not otherwise deducible.
<br/><br/>Sorry, I don't understand what you mean by &quot;which parent child is
<br/>currently visited&quot;. &nbsp;Care to clarify?
<br/><br/>&gt; To better understand this try to imagine an application that want to
<br/>&gt; check lhs of assign binary operator.
<br/><br/>-- 
<br/>Zhanyong
<br/><br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=872318&i=1" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=14308">Abramo Bagnara-2</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=872322" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a872322',872322)">Threaded</a>
	<div id="tooltip31821" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip31821'), 'up', 400);
	</script> |
					<span id="dd_postdropdown872322"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown872322", "More","Click for more options");
		
		dropdown.add('replyToAuthor872322', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D872322\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost872322', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D872322\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost872322', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D872322\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost872322', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(872322)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively872322', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(872322)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate872322', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D872322\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print872322', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D872322\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink872322', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p872322.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail872322', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D872322\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown872322');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=872322' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(872322)"/>
	<div id="tooltip47189" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip47189'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow872322" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275725866000-939"></span><script type="text/javascript">
		Nabble.get('d1275725866000-939').innerHTML= Nabble.formatDateLong(new Date(1275725866000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=14308" rel="nofollow" title="View profile of Abramo Bagnara-2" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/4368dd8fb7dddc53e260d73e6d681ee5?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Abramo Bagnara-2" title="Abramo Bagnara-2"/><img src="/images/online.png" class="online14308 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count14308 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message872322" class="message-text adbayes-content">
		&gt;&gt; Another very useful thing you should consider is to add a child
<br/>&gt;&gt; identifier to handler arguments that inform handler about *which* parent
<br/>&gt;&gt; child is currently visited: this information is not otherwise deducible.
<br/>&gt; 
<br/>&gt; Sorry, I don't understand what you mean by &quot;which parent child is
<br/>&gt; currently visited&quot;. &nbsp;Care to clarify?
<br/>&gt; 
<br/>&gt;&gt; To better understand this try to imagine an application that want to
<br/>&gt;&gt; check lhs of assign binary operator.
<br/><br/>As you've noted in your documentation it might be useful to know the
<br/>ancestor chain of current node and for this aim it is possibile to save
<br/>a stack of node entered, but what about to know *which* child of its
<br/>parent current node is?
<br/><br/>This info is not available or deducible *unless* the parent visit (in
<br/>its general purpose code) pass down this information.
<br/><br/>This make possibile to node visit to answer to the following questions:
<br/><br/>&quot;I'm the lhs or the rhs expression?&quot;, &quot;I'm the return type of function
<br/>decl or the full function type?&quot;, &nbsp;&quot;I'm the return type of function type
<br/>or an argument type?&quot;, etc.
<br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=872322&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960">Zhanyong Wan (λx.x x)</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=872407" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a872407',872407)">Threaded</a>
	<div id="tooltip23527" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip23527'), 'up', 400);
	</script> |
					<span id="dd_postdropdown872407"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown872407", "More","Click for more options");
		
		dropdown.add('replyToAuthor872407', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D872407\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost872407', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D872407\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost872407', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D872407\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost872407', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(872407)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively872407', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(872407)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate872407', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D872407\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print872407', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D872407\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink872407', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p872407.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail872407', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D872407\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown872407');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=872407' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(872407)"/>
	<div id="tooltip33266" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip33266'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow872407" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275726617000-571"></span><script type="text/javascript">
		Nabble.get('d1275726617000-571').innerHTML= Nabble.formatDateLong(new Date(1275726617000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960" rel="nofollow" title="View profile of Zhanyong Wan (λx.x x)" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/77efdc542a2e6f7a356c42031ed41a9f?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Zhanyong Wan (λx.x x)" title="Zhanyong Wan (λx.x x)"/><img src="/images/online.png" class="online12960 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count12960 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message872407" class="message-text adbayes-content">
		On Saturday, June 5, 2010, Abramo Bagnara &lt;<a href="/user/SendEmail.jtp?type=node&node=872407&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt; wrote:
<div class='shrinkable-quote'><br/>&gt;&gt;&gt; Another very useful thing you should consider is to add a child
<br/>&gt;&gt;&gt; identifier to handler arguments that inform handler about *which* parent
<br/>&gt;&gt;&gt; child is currently visited: this information is not otherwise deducible.
<br/>&gt;&gt;
<br/>&gt;&gt; Sorry, I don't understand what you mean by &quot;which parent child is
<br/>&gt;&gt; currently visited&quot;.  Care to clarify?
<br/>&gt;&gt;
<br/>&gt;&gt;&gt; To better understand this try to imagine an application that want to
<br/>&gt;&gt;&gt; check lhs of assign binary operator.
<br/>&gt;
<br/>&gt; As you've noted in your documentation it might be useful to know the
<br/>&gt; ancestor chain of current node and for this aim it is possibile to save
<br/>&gt; a stack of node entered, but what about to know *which* child of its
<br/>&gt; parent current node is?
<br/>&gt;
<br/>&gt; This info is not available or deducible *unless* the parent visit (in
</div><br/>It is easily deducible. &nbsp;Just search for the current node (a pointer)
<br/>in the parent's children.
<br/><br/>&gt; its general purpose code) pass down this information.
<br/>&gt;
<br/>&gt; This make possibile to node visit to answer to the following questions:
<br/>&gt;
<br/>&gt; &quot;I'm the lhs or the rhs expression?&quot;, &quot;I'm the return type of function
<br/>&gt; decl or the full function type?&quot;,  &quot;I'm the return type of function type
<br/>&gt; or an argument type?&quot;, etc.
<br/><br/>Just compare the pointer to the current node with the parent node's
<br/>lhs expression child, etc.
<br/><br/>-- 
<br/>Zhanyong
<br/><br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=872407&i=1" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=60154">Jordy Rose</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=873395" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a873395',873395)">Threaded</a>
	<div id="tooltip15676" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip15676'), 'up', 400);
	</script> |
					<span id="dd_postdropdown873395"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown873395", "More","Click for more options");
		
		dropdown.add('replyToAuthor873395', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D873395\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost873395', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D873395\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost873395', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D873395\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost873395', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(873395)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively873395', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(873395)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate873395', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D873395\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print873395', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D873395\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink873395', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p873395.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail873395', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D873395\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown873395');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=873395' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(873395)"/>
	<div id="tooltip40536" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip40536'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow873395" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275780028000-998"></span><script type="text/javascript">
		Nabble.get('d1275780028000-998').innerHTML= Nabble.formatDateLong(new Date(1275780028000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=60154" rel="nofollow" title="View profile of Jordy Rose" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/a6c4bc2466f8001170030777c5aa050c?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Jordy Rose" title="Jordy Rose"/><img src="/images/online.png" class="online60154 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count60154 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	<div class="weak-color" style="font-size:80%;padding-bottom:1em">
				In reply to <a href="http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799.html" rel="nofollow">this post</a> by Zhanyong Wan (λx.x x)
			</div>
	<div id="message873395" class="message-text adbayes-content">
		<br/>Having just written a small tree-walker myself, I want to ask what
<br/>returning &quot;false&quot; means. There's lots of ways you might want to &quot;stop&quot; in
<br/>the middle of a traversal:
<br/><br/>1. Stop traversing altogether. This is what the original proposal says, if
<br/>I'm reading it correctly.
<br/><br/>2. Stop walking the class hierarchy, but still traverse the children. This
<br/>doesn't seem very useful -- a client could probably get around this without
<br/>any real trouble.
<br/><br/>3. Skip this node's children and move on to the next node. Would have to
<br/>override TraverseFoo() for this right now, but not so hard since you just
<br/>call WalkUpFromFoo() and don't look at the children.
<br/><br/>4. Skip the rest of the /parent/'s children. This is definitely trickier.
<br/><br/>5. Jump an arbitrary number of levels back up (i.e. #4 recursively).
<br/>Probably not very common, but powerful enough to implement #3, #4, and #1,
<br/>with each one wrapped in simple API.
<br/><br/><br/>Do you (or does anyone) think there are enough uses of #3, #4, or #5 to
<br/>warrant implementing something like this? A nice way to do it could be a
<br/>simple push()/pop() system -- when you say abort, it pop()s back to the
<br/>last saved node. Alternately, you could return a special value that says
<br/>how far back to pop() (such as a particular Stmt*), with special constants
<br/>for &quot;Continue&quot; and &quot;Abort&quot;.
<br/><br/>Overall, though, I like the separation of responsibility. I'm wondering a
<br/>little bit about Abramo's point of pre- and post- visiting -- sometimes you
<br/>might need the children first before you can finish the parent. (For
<br/>example, the type of an expression depends on its children...not that we'd
<br/>be using RecursiveASTVisitor to figure out types.)
<br/><br/>Jordy
<br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=873395&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960">Zhanyong Wan (λx.x x)</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=876406" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a876406',876406)">Threaded</a>
	<div id="tooltip62904" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip62904'), 'up', 400);
	</script> |
					<span id="dd_postdropdown876406"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown876406", "More","Click for more options");
		
		dropdown.add('replyToAuthor876406', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D876406\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost876406', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D876406\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost876406', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D876406\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost876406', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(876406)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively876406', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(876406)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate876406', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D876406\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print876406', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D876406\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink876406', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p876406.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail876406', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D876406\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown876406');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=876406' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(876406)"/>
	<div id="tooltip90787" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip90787'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow876406" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275804460000-286"></span><script type="text/javascript">
		Nabble.get('d1275804460000-286').innerHTML= Nabble.formatDateLong(new Date(1275804460000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960" rel="nofollow" title="View profile of Zhanyong Wan (λx.x x)" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/77efdc542a2e6f7a356c42031ed41a9f?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Zhanyong Wan (λx.x x)" title="Zhanyong Wan (λx.x x)"/><img src="/images/online.png" class="online12960 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count12960 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message876406" class="message-text adbayes-content">
		On Sat, Jun 5, 2010 at 4:20 PM, Jordy Rose &lt;<a href="/user/SendEmail.jtp?type=node&node=876406&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt; wrote:
<br/>&gt;
<br/>&gt; Having just written a small tree-walker myself, I want to ask what
<br/>&gt; returning &quot;false&quot; means. There's lots of ways you might want to &quot;stop&quot; in
<br/>&gt; the middle of a traversal:
<br/>&gt;
<br/>&gt; 1. Stop traversing altogether. This is what the original proposal says, if
<br/>&gt; I'm reading it correctly.
<br/><br/>Yes, that's what I meant. &nbsp;Think of it as throwing an exception.
<br/><br/>&gt; 2. Stop walking the class hierarchy, but still traverse the children. This
<br/>&gt; doesn't seem very useful -- a client could probably get around this without
<br/>&gt; any real trouble.
<br/><br/>Agreed.
<br/><br/>&gt; 3. Skip this node's children and move on to the next node. Would have to
<br/>&gt; override TraverseFoo() for this right now, but not so hard since you just
<br/>&gt; call WalkUpFromFoo() and don't look at the children.
<br/><br/>Agreed. &nbsp;It's easy for a user to do this.
<br/><br/>&gt; 4. Skip the rest of the /parent/'s children. This is definitely trickier.
<br/><br/>You can override TraverseParent(). &nbsp;Doable.
<br/><div class='shrinkable-quote'><br/>&gt; 5. Jump an arbitrary number of levels back up (i.e. #4 recursively).
<br/>&gt; Probably not very common, but powerful enough to implement #3, #4, and #1,
<br/>&gt; with each one wrapped in simple API.
<br/>&gt;
<br/>&gt;
<br/>&gt; Do you (or does anyone) think there are enough uses of #3, #4, or #5 to
<br/>&gt; warrant implementing something like this? A nice way to do it could be a
<br/>&gt; simple push()/pop() system -- when you say abort, it pop()s back to the
<br/>&gt; last saved node. Alternately, you could return a special value that says
<br/>&gt; how far back to pop() (such as a particular Stmt*), with special constants
<br/>&gt; for &quot;Continue&quot; and &quot;Abort&quot;.
</div><br/>I suspect we are getting a bit ahead of ourselves here. &nbsp;I like to
<br/>make the design as general as possible too - as long as we don't
<br/>introduce unnecessary complexity. &nbsp;I think the use cases you described
<br/>are rare, and I'm fine with not supporting them directly. &nbsp;The user
<br/>can always override enough methods to make the AST visitor do whatever
<br/>he wants to do. &nbsp;Or he may just create a new AST visitor class if that
<br/>makes more sense.
<br/><br/>&gt; Overall, though, I like the separation of responsibility. I'm wondering a
<br/>&gt; little bit about Abramo's point of pre- and post- visiting -- sometimes you
<br/>&gt; might need the children first before you can finish the parent. (For
<br/>&gt; example, the type of an expression depends on its children...not that we'd
<br/>&gt; be using RecursiveASTVisitor to figure out types.)
<br/><br/>Support for postorder traversal can be added later without breaking
<br/>existing users. &nbsp;We just need to add a bunch of PostVisitFoo() methods
<br/>and change WalkUpFromFoo()'s body to:
<br/><br/>{
<br/>&nbsp; VisitFoo(x);
<br/>&nbsp; WalkUpFromBar(x);
<br/>&nbsp; PostVisitFoo(x); &nbsp;// This is new.
<br/>}
<br/><br/>Therefore I don't intend to bloat the API with this upfront.
<br/><br/>Thanks!
<br/><br/>&gt; Jordy
<br/>&gt; _______________________________________________
<br/>&gt; cfe-dev mailing list
<br/>&gt; <a href="/user/SendEmail.jtp?type=node&node=876406&i=1" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/>&gt; <a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>&gt;
<br/><br/><br/><br/>-- 
<br/>Zhanyong
<br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=876406&i=2" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=60154">Jordy Rose</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=876413" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a876413',876413)">Threaded</a>
	<div id="tooltip34899" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip34899'), 'up', 400);
	</script> |
					<span id="dd_postdropdown876413"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown876413", "More","Click for more options");
		
		dropdown.add('replyToAuthor876413', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D876413\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost876413', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D876413\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost876413', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D876413\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost876413', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(876413)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively876413', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(876413)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate876413', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D876413\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print876413', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D876413\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink876413', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p876413.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail876413', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D876413\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown876413');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=876413' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(876413)"/>
	<div id="tooltip90559" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip90559'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow876413" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275805837000-537"></span><script type="text/javascript">
		Nabble.get('d1275805837000-537').innerHTML= Nabble.formatDateLong(new Date(1275805837000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=60154" rel="nofollow" title="View profile of Jordy Rose" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/a6c4bc2466f8001170030777c5aa050c?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Jordy Rose" title="Jordy Rose"/><img src="/images/online.png" class="online60154 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count60154 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message876413" class="message-text adbayes-content">
		<br/>On Sat, 5 Jun 2010 23:07:40 -0700, Zhanyong Wan (λx.x x) &lt;<a href="/user/SendEmail.jtp?type=node&node=876413&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt;
<br/>wrote:
<br/>&gt; On Sat, Jun 5, 2010 at 4:20 PM, Jordy Rose &lt;<a href="/user/SendEmail.jtp?type=node&node=876413&i=1" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt;
<br/>wrote:
<br/>&gt;&gt;
<br/>&gt;&gt; Having just written a small tree-walker myself, I want to ask what
<br/>&gt;&gt; returning &quot;false&quot; means. There's lots of ways you might want to &quot;stop&quot;
<br/>in
<br/>&gt;&gt; the middle of a traversal:
<br/>&gt;&gt;
<br/>&gt;&gt; 1. Stop traversing altogether. This is what the original proposal says,
<br/>&gt;&gt; if
<br/>&gt;&gt; I'm reading it correctly.
<br/>&gt; 
<br/>&gt; Yes, that's what I meant. &nbsp;Think of it as throwing an exception.
<br/><br/>&lt;snip&gt;
<br/><br/>&gt;&gt; Do you (or does anyone) think there are enough uses of #3, #4, or #5 to
<br/>&gt;&gt; warrant implementing something like this? A nice way to do it could be
<br/>a
<br/>&gt;&gt; simple push()/pop() system -- when you say abort, it pop()s back to the
<br/>&gt;&gt; last saved node. Alternately, you could return a special value that
<br/>says
<div class='shrinkable-quote'><br/>&gt;&gt; how far back to pop() (such as a particular Stmt*), with special
<br/>&gt;&gt; constants
<br/>&gt;&gt; for &quot;Continue&quot; and &quot;Abort&quot;.
<br/>&gt; 
<br/>&gt; I suspect we are getting a bit ahead of ourselves here. &nbsp;I like to
<br/>&gt; make the design as general as possible too - as long as we don't
<br/>&gt; introduce unnecessary complexity. &nbsp;I think the use cases you described
<br/>&gt; are rare, and I'm fine with not supporting them directly. &nbsp;The user
<br/>&gt; can always override enough methods to make the AST visitor do whatever
<br/>&gt; he wants to do. &nbsp;Or he may just create a new AST visitor class if that
<br/>&gt; makes more sense.
</div><br/>Heh, I suppose so. I started out writing with the intent to make sure
<br/>&quot;stop&quot; was well-defined (and eventually, clearly documented), but then got
<br/>carried away with all the possible uses. Of course it's easy to modify
<br/>behavior by subclasing RecursiveASTVisitor.
<br/><br/>Thanks,
<br/>Jordy
<br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=876413&i=2" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=8571">Olaf Krzikalla</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=876415" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a876415',876415)">Threaded</a>
	<div id="tooltip88624" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip88624'), 'up', 400);
	</script> |
					<span id="dd_postdropdown876415"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown876415", "More","Click for more options");
		
		dropdown.add('replyToAuthor876415', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D876415\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost876415', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D876415\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost876415', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D876415\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost876415', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(876415)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively876415', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(876415)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate876415', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D876415\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print876415', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D876415\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink876415', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p876415.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail876415', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D876415\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown876415');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=876415' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(876415)"/>
	<div id="tooltip6721" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip6721'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow876415" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1275901758000-836"></span><script type="text/javascript">
		Nabble.get('d1275901758000-836').innerHTML= Nabble.formatDateLong(new Date(1275901758000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=8571" rel="nofollow" title="View profile of Olaf Krzikalla" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/d35b617b8b7da71e8897b13952a1261a?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Olaf Krzikalla" title="Olaf Krzikalla"/><img src="/images/online.png" class="online8571 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count8571 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	<div class="weak-color" style="font-size:80%;padding-bottom:1em">
				In reply to <a href="http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799.html" rel="nofollow">this post</a> by Zhanyong Wan (λx.x x)
			</div>
	<div id="message876415" class="message-text adbayes-content">
		I've build my AST traversal on top of llvm's df_iterator.
<br/><br/>To get an idea, check
<br/><br/><a href="https://gforge.zih.tu-dresden.de/scm/viewvc.php/trunk/Scout/clangAddons/include/clang/ASTProcessing/StmtTraversal.h?root=hicfd&view=markup" target="_top" rel="nofollow" link="external">https://gforge.zih.tu-dresden.de/scm/viewvc.php/trunk/Scout/clangAddons/include/clang/ASTProcessing/StmtTraversal.h?root=hicfd&amp;view=markup</a><br/><br/>stmt_iterator enables the traversal over a particular type, which at 
<br/>least for me is sufficient in most cases. For more complex tasks there 
<br/>is visit_df taking a StmtVisitor.
<br/><br/>Best regards
<br/>Olaf Krzikalla
<br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=876415&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960">Zhanyong Wan (λx.x x)</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=880647" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a880647',880647)">Threaded</a>
	<div id="tooltip47933" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip47933'), 'up', 400);
	</script> |
					<span id="dd_postdropdown880647"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown880647", "More","Click for more options");
		
		dropdown.add('replyToAuthor880647', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D880647\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost880647', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D880647\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost880647', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D880647\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost880647', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(880647)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively880647', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(880647)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate880647', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D880647\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print880647', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D880647\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink880647', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p880647.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail880647', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D880647\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown880647');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=880647' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(880647)"/>
	<div id="tooltip90408" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip90408'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow880647" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1276033470000-829"></span><script type="text/javascript">
		Nabble.get('d1276033470000-829').innerHTML= Nabble.formatDateLong(new Date(1276033470000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960" rel="nofollow" title="View profile of Zhanyong Wan (λx.x x)" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/77efdc542a2e6f7a356c42031ed41a9f?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Zhanyong Wan (λx.x x)" title="Zhanyong Wan (λx.x x)"/><img src="/images/online.png" class="online12960 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count12960 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	<div class="weak-color" style="font-size:80%;padding-bottom:1em">
				In reply to <a href="http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799.html" rel="nofollow">this post</a> by Zhanyong Wan (λx.x x)
			</div>
	<div id="message880647" class="message-text adbayes-content">
		Hi, all,
<br/><br/>Craig and I implemented most of the new design. &nbsp;I uploaded the patch
<br/>to <a href="http://codereview.appspot.com/1607042" target="_top" rel="nofollow" link="external">http://codereview.appspot.com/1607042</a>&nbsp;for easy reviewing - you can
<br/>download it from
<br/><a href="http://codereview.appspot.com/download/issue1607042_1.diff" target="_top" rel="nofollow" link="external">http://codereview.appspot.com/download/issue1607042_1.diff</a><br/><br/>In the implementation we made a slight change to the proposed design:
<br/>instead of overloading Traverse() for Stmt, Type, and Decl, we prefer
<br/>to have separate TraverseStmt, TraverseType, and TraverseDecl
<br/>functions. &nbsp;We think that makes the code clearer.
<br/><br/>Chandler plan to review it after 3pm today. &nbsp;Doug, would you have some
<br/>time to look at this today? &nbsp;Thanks!
<br/><br/>On Fri, Jun 4, 2010 at 4:35 PM, Zhanyong Wan (λx.x x) &lt;<a href="/user/SendEmail.jtp?type=node&node=880647&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt; wrote:
<div class='shrinkable-quote'><br/>&gt; Hi,
<br/>&gt;
<br/>&gt; While working on improving the RecursiveASTVisitor class, some of us saw an
<br/>&gt; opportunity for a different design that's cleaner and easier to understand
<br/>&gt; and use.  Here's the proposal.  Comments and suggestions welcome!
<br/>&gt;
<br/>&gt; Clang AST Visitor Design
<br/>&gt;
<br/>&gt; This document discusses the design of a customizable visitor class for the
<br/>&gt; AST generated by the Clang C++ parser.
<br/>&gt;
<br/>&gt; Background
<br/>&gt;
<br/>&gt; Clang comes with two AST visitor classes: ASTVisitor and
<br/>&gt; RecursiveASTVisitor. The ideas behind the two are similar. Both are
<br/>&gt; implemented using the CRTP pattern. The former is considered an internal
<br/>&gt; class and not for use in tools developed on top of Clang. The latter is
<br/>&gt; supposed to be a public API.
<br/>&gt;
<br/>&gt; At this time, neither class is complete (i.e. they'll miss some AST nodes)
<br/>&gt; and there are known bugs (e.g. some AST nodes may be visited more than
<br/>&gt; once). We are working on improving RecursiveASTVisitor. Our experience shows
<br/>&gt; that its design has much space for improvement. Therefore it would be a
<br/>&gt; worthwhile exercise to see what we can come up with if we do it from
<br/>&gt; scratch, without being constrained or influenced by the current
<br/>&gt; RecursiveASTVisitor design.
<br/>&gt;
<br/>&gt; Concepts and Terminology
<br/>&gt;
<br/>&gt; Muddy concepts lead to poor, confusing designs. Before we explore the design
<br/>&gt; space, it's important to clarify some key concepts.
<br/>&gt;
<br/>&gt; An AST is a tree-shaped data structure. A node in an AST can have 0 or many
<br/>&gt; other nodes as its children.
<br/>&gt; There a three categories of AST nodes in Clang: statements,
<br/>&gt; declarations/definitions, and types. They are derived from class Stmt, Decl,
<br/>&gt; and TypeLoc, respectively. In general, a node may have children of any or
<br/>&gt; all of the three categories. The class hierarchies for Stmt, Decl, and
<br/>&gt; TypeLoc can be found here.
<br/>&gt; The AST visitor has three distinct tasks:
<br/>&gt;
<br/>&gt; traverse the entire AST (i.e. go to every node),
<br/>&gt; at each node, walk up the class hierarchy, starting with the dynamic type of
<br/>&gt; the node,
<br/>&gt; for a given (node, type) combination (where 'type' is some base class of the
<br/>&gt; dynamic type of 'node'), call a user-overridable function to actually
<br/>&gt; &quot;visit&quot; the node.
<br/>&gt;
<br/>&gt; Design Goals
<br/>&gt;
<br/>&gt; easy-to-understand API
<br/>&gt; performs a depth-first, preorder traversal on the AST (no child of a node
<br/>&gt; can be visited until all work on the node has been done)
<br/>&gt; complete coverage: each node in the AST must be visited
<br/>&gt; no duplication: a node cannot be visited more than once
<br/>&gt; common use cases should be easy
<br/>&gt; fast
<br/>&gt;
<br/>&gt; Our Design
<br/>&gt;
<br/>&gt; The distinction between the AST visitor's three tasks (see the &quot;Concepts and
<br/>&gt; Terminology&quot; section above) is important for understanding how the AST
<br/>&gt; visitor works and using it effectively. Therefore we use naming conventions
<br/>&gt; to highlight the role of a method of the AST visitor:
<br/>&gt;
<br/>&gt; TraverseFoo(Foo* x) does task #1. It traveses (i.e. recursively visits) the
<br/>&gt; sub-tree rooted at x, where Foo is *x's dynamic type (it's the caller's
<br/>&gt; responsibility to ensure the correct type).
<br/>&gt; Traverse(Decl* x) simply dispatches (i.e. forwards) to TraverseFoo(Foo* x)
<br/>&gt; where Foo is the dynamic type of *x. Traverse(Stmt* x) and Traverse(TypeLoc*
<br/>&gt; x) work similarly.
<br/>&gt; WalkUpFromFoo(Foo* x) (better name welcome) does task #2. It does not try to
<br/>&gt; visit any child of x. Instead, it first calls WalkUpFromBar(x) where Bar is
<br/>&gt; the direct parent class of Foo (unless Foo has no parent), and then calls
<br/>&gt; VisitFoo(x) (see the next bullet).
<br/>&gt; VisitFoo(Foo* x) does task #3.
<br/>&gt;
<br/>&gt; Here's some pesudo code to show what these methods' implementation looks
<br/>&gt; like:
<br/>&gt;
<br/>&gt; // A function returns false if it wants the traversal to abort (note that
<br/>&gt; // the current RecursiveASTVisitor class returns true for abortion - we
<br/>&gt; // feel that 'false' is much more intuitive).
<br/>&gt;
<br/>&gt; // Therefore, each caller needs to check the return code and propagate
<br/>&gt; // it up appropriately.  Such plumbing code is omitted here for clarify.
<br/>&gt;
<br/>&gt;
<br/>&gt; // The entry point for visiting an AST rooted at x.
<br/>&gt; bool Traverse(Decl* x) {
<br/>&gt;
<br/>&gt;   switch(x-&gt;getKind()) {
<br/>&gt;
<br/>&gt;   case kFoo:
<br/>&gt;     TraverseFoo((Foo*)x);
<br/>&gt;
<br/>&gt;     break;
<br/>&gt;   case kBar:
<br/>&gt;     TraverseBar((Bar*)x);
<br/>&gt;
<br/>&gt;     break;
<br/>&gt;   ...
<br/>&gt;   }
<br/>&gt; }
<br/>&gt;
<br/>&gt;
<br/>&gt; bool TraverseFoo(Foo* x) {
<br/>&gt;
<br/>&gt;   WalkUpFromFoo(x);
<br/>&gt;   for each child node n of x {
<br/>&gt;
<br/>&gt;     Traverse(n)
<br/>&gt;   }
<br/>&gt; }
<br/>&gt;
<br/>&gt;
<br/>&gt; bool WalkUpFromFoo(Foo* x) {
<br/>&gt;
<br/>&gt;   WalkUpFromBar(x);  // Bar is Foo's parent.
<br/>&gt;
<br/>&gt;   VisitFoo(x);
<br/>&gt; }
<br/>&gt;
<br/>&gt; bool WalkUpFromDecl(Decl* x) {
<br/>&gt;
<br/>&gt;   // Decl has no parent, so no more walking up.
<br/>&gt;   VisitDecl(x);
<br/>&gt;
<br/>&gt; }
<br/>&gt;
<br/>&gt; // All Visit*() methods do nothing by default.
<br/>&gt; bool VisitFoo(Foo* x) { return true; }
<br/>&gt;
<br/>&gt; Usually, a user shouldn't override a Traverse*() or WalkUpFrom*() function -
<br/>&gt; they are the &quot;skeleton&quot; of the AST visitor and do the mundane plumbing that
<br/>&gt; a normal user is not interested in. We recommend that only people truly
<br/>&gt; understand how the traversal works can override them.
<br/>&gt;
<br/>&gt; A user is expected to override the Visit*() methods as needed. The default
<br/>&gt; implementation of them does nothing.
<br/>&gt;
<br/>&gt; Returning a bool to indicate whether the traversal needs to be aborted
<br/>&gt; requires much tedious, error-prone plumbing in the implementation.
<br/>&gt; Exceptions are the most natural solution here, but unfortunately they are
<br/>&gt; banned from Clang code.
<br/>&gt;
<br/>&gt; One advantage of this design over the existing RecursiveASTVisitor is that
<br/>&gt; when a user overrides VisitFoo(), he only needs to do what he's interested
<br/>&gt; in, without worrying about calling VisitFoo() or any other methods in the
<br/>&gt; base AST visitor class (so less chance to shoot his own feet).
<br/>&gt;
<br/>&gt; With this design, all Visit*() methods on an AST ndoe are called before any
<br/>&gt; Visit*() method is called on a child node of it.  So the trace of the
<br/>&gt; Visit*() calls is easy to understand and reason about.
<br/>&gt;
<br/>&gt; One thing people might not like about the design is that it uses more
<br/>&gt; methods. I actually think it's a good thing that we have separate families
<br/>&gt; of methods for separate roles. RecursiveASTVisitor's approach of lumping all
<br/>&gt; logic (traversal, walking up the type hierarchy, and the custom visiting
<br/>&gt; logic) in the same Visit*() method makes the implementation more tricky and
<br/>&gt; error-prone - that's probably why there was so much confusion when we were
<br/>&gt; trying to improve RecursiveASTVisitor.
<br/>&gt;
<br/>&gt; To ensure performance, we would use CRTP as the existing AST visitors do.
<br/>&gt; That means two things:
<br/>&gt;
<br/>&gt; No need for virtual functions.
<br/>&gt; The entire code is templated s.t. the compiler can easily inline trivial
<br/>&gt; functions and do cross-function optimization.
<br/>&gt;
<br/>&gt; Use Cases
<br/>&gt;
<br/>&gt; Let's see how some typical use cases can be implemented using our AST
<br/>&gt; visitor.
<br/>&gt;
<br/>&gt; Dump the AST
<br/>&gt;
<br/>&gt; Only 3 methods need to be overridden:
<br/>&gt;
<br/>&gt; VisitDecl(Decl* x) {
<br/>&gt;
<br/>&gt;   print information about x;
<br/>&gt; }
<br/>&gt;
<br/>&gt; VisitStmt(Stmt* x) {
<br/>&gt;
<br/>&gt;   print information about x;
<br/>&gt; }
<br/>&gt;
<br/>&gt; VisitTypeLoc(TypeLoc* x) {
<br/>&gt;
<br/>&gt;   print information about x;
<br/>&gt; }
<br/>&gt;
<br/>&gt; Search for an AST Node of Type Foo
<br/>&gt;
<br/>&gt; The tool would override VisitFoo(Foo* x) to return false if x is the node
<br/>&gt; it's looking for.
<br/>&gt;
<br/>&gt; Find the Parents of an AST Node
<br/>&gt;
<br/>&gt; The tool would maintain a stack of the nodes that lead to the current node.
<br/>&gt; It can build the stack by overriding exactly 3 methods (plumbing of the
<br/>&gt; return code omitted):
<br/>&gt;
<br/>&gt; Traverse(Decl* d) {
<br/>&gt;
<br/>&gt;   Push(d);
<br/>&gt;   Base::Traverse(d);
<br/>&gt;
<br/>&gt;   Pop();
<br/>&gt; }
<br/>&gt;
<br/>&gt; Traverse(Stmt* s) {
<br/>&gt;
<br/>&gt;   Push(s);
<br/>&gt;   Base::Traverse(s);
<br/>&gt;
<br/>&gt;   Pop();
<br/>&gt; }
<br/>&gt;
<br/>&gt; Traverse(TypeLoc* t) {
<br/>&gt;
<br/>&gt;   Push(t);
<br/>&gt;   Base::Traverse(t);
<br/>&gt;
<br/>&gt;   Pop();
<br/>&gt; }
<br/>&gt;
<br/>&gt; --
<br/>&gt; Zhanyong
<br/>&gt;
<br/>&gt;
</div><br/><br/><br/>-- 
<br/>Zhanyong
<br/><br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=880647&i=1" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=8574">Douglas Gregor</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=880947" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a880947',880947)">Threaded</a>
	<div id="tooltip83335" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip83335'), 'up', 400);
	</script> |
					<span id="dd_postdropdown880947"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown880947", "More","Click for more options");
		
		dropdown.add('replyToAuthor880947', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D880947\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost880947', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D880947\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost880947', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D880947\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost880947', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(880947)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively880947', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(880947)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate880947', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D880947\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print880947', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D880947\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink880947', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p880947.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail880947', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D880947\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown880947');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=880947' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(880947)"/>
	<div id="tooltip36676" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip36676'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow880947" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1276043596000-206"></span><script type="text/javascript">
		Nabble.get('d1276043596000-206').innerHTML= Nabble.formatDateLong(new Date(1276043596000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=8574" rel="nofollow" title="View profile of Douglas Gregor" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/3c450c87df0788b8e1f7a6ca17ea34c7?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Douglas Gregor" title="Douglas Gregor"/><img src="/images/online.png" class="online8574 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count8574 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message880947" class="message-text adbayes-content">
		<br/>On Jun 8, 2010, at 2:44 PM, Zhanyong Wan (λx.x x) wrote:
<br/><div class='shrinkable-quote'><br/>&gt; Hi, all,
<br/>&gt; 
<br/>&gt; Craig and I implemented most of the new design. &nbsp;I uploaded the patch
<br/>&gt; to <a href="http://codereview.appspot.com/1607042" target="_top" rel="nofollow" link="external">http://codereview.appspot.com/1607042</a>&nbsp;for easy reviewing - you can
<br/>&gt; download it from
<br/>&gt; <a href="http://codereview.appspot.com/download/issue1607042_1.diff" target="_top" rel="nofollow" link="external">http://codereview.appspot.com/download/issue1607042_1.diff</a><br/>&gt; 
<br/>&gt; In the implementation we made a slight change to the proposed design:
<br/>&gt; instead of overloading Traverse() for Stmt, Type, and Decl, we prefer
<br/>&gt; to have separate TraverseStmt, TraverseType, and TraverseDecl
<br/>&gt; functions. &nbsp;We think that makes the code clearer.
<br/>&gt; 
<br/>&gt; Chandler plan to review it after 3pm today. &nbsp;Doug, would you have some
<br/>&gt; time to look at this today? &nbsp;Thanks!
</div><br/>I've added my comments up on codereview.appspot.com. Looks good!
<br/><br/>&nbsp; &nbsp; &nbsp; &nbsp; - Doug
<br/><div class='shrinkable-quote'><br/>&gt; On Fri, Jun 4, 2010 at 4:35 PM, Zhanyong Wan (λx.x x) &lt;<a href="/user/SendEmail.jtp?type=node&node=880947&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt; wrote:
<br/>&gt;&gt; Hi,
<br/>&gt;&gt; 
<br/>&gt;&gt; While working on improving the RecursiveASTVisitor class, some of us saw an
<br/>&gt;&gt; opportunity for a different design that's cleaner and easier to understand
<br/>&gt;&gt; and use. &nbsp;Here's the proposal. &nbsp;Comments and suggestions welcome!
<br/>&gt;&gt; 
<br/>&gt;&gt; Clang AST Visitor Design
<br/>&gt;&gt; 
<br/>&gt;&gt; This document discusses the design of a customizable visitor class for the
<br/>&gt;&gt; AST generated by the Clang C++ parser.
<br/>&gt;&gt; 
<br/>&gt;&gt; Background
<br/>&gt;&gt; 
<br/>&gt;&gt; Clang comes with two AST visitor classes: ASTVisitor and
<br/>&gt;&gt; RecursiveASTVisitor. The ideas behind the two are similar. Both are
<br/>&gt;&gt; implemented using the CRTP pattern. The former is considered an internal
<br/>&gt;&gt; class and not for use in tools developed on top of Clang. The latter is
<br/>&gt;&gt; supposed to be a public API.
<br/>&gt;&gt; 
<br/>&gt;&gt; At this time, neither class is complete (i.e. they'll miss some AST nodes)
<br/>&gt;&gt; and there are known bugs (e.g. some AST nodes may be visited more than
<br/>&gt;&gt; once). We are working on improving RecursiveASTVisitor. Our experience shows
<br/>&gt;&gt; that its design has much space for improvement. Therefore it would be a
<br/>&gt;&gt; worthwhile exercise to see what we can come up with if we do it from
<br/>&gt;&gt; scratch, without being constrained or influenced by the current
<br/>&gt;&gt; RecursiveASTVisitor design.
<br/>&gt;&gt; 
<br/>&gt;&gt; Concepts and Terminology
<br/>&gt;&gt; 
<br/>&gt;&gt; Muddy concepts lead to poor, confusing designs. Before we explore the design
<br/>&gt;&gt; space, it's important to clarify some key concepts.
<br/>&gt;&gt; 
<br/>&gt;&gt; An AST is a tree-shaped data structure. A node in an AST can have 0 or many
<br/>&gt;&gt; other nodes as its children.
<br/>&gt;&gt; There a three categories of AST nodes in Clang: statements,
<br/>&gt;&gt; declarations/definitions, and types. They are derived from class Stmt, Decl,
<br/>&gt;&gt; and TypeLoc, respectively. In general, a node may have children of any or
<br/>&gt;&gt; all of the three categories. The class hierarchies for Stmt, Decl, and
<br/>&gt;&gt; TypeLoc can be found here.
<br/>&gt;&gt; The AST visitor has three distinct tasks:
<br/>&gt;&gt; 
<br/>&gt;&gt; traverse the entire AST (i.e. go to every node),
<br/>&gt;&gt; at each node, walk up the class hierarchy, starting with the dynamic type of
<br/>&gt;&gt; the node,
<br/>&gt;&gt; for a given (node, type) combination (where 'type' is some base class of the
<br/>&gt;&gt; dynamic type of 'node'), call a user-overridable function to actually
<br/>&gt;&gt; &quot;visit&quot; the node.
<br/>&gt;&gt; 
<br/>&gt;&gt; Design Goals
<br/>&gt;&gt; 
<br/>&gt;&gt; easy-to-understand API
<br/>&gt;&gt; performs a depth-first, preorder traversal on the AST (no child of a node
<br/>&gt;&gt; can be visited until all work on the node has been done)
<br/>&gt;&gt; complete coverage: each node in the AST must be visited
<br/>&gt;&gt; no duplication: a node cannot be visited more than once
<br/>&gt;&gt; common use cases should be easy
<br/>&gt;&gt; fast
<br/>&gt;&gt; 
<br/>&gt;&gt; Our Design
<br/>&gt;&gt; 
<br/>&gt;&gt; The distinction between the AST visitor's three tasks (see the &quot;Concepts and
<br/>&gt;&gt; Terminology&quot; section above) is important for understanding how the AST
<br/>&gt;&gt; visitor works and using it effectively. Therefore we use naming conventions
<br/>&gt;&gt; to highlight the role of a method of the AST visitor:
<br/>&gt;&gt; 
<br/>&gt;&gt; TraverseFoo(Foo* x) does task #1. It traveses (i.e. recursively visits) the
<br/>&gt;&gt; sub-tree rooted at x, where Foo is *x's dynamic type (it's the caller's
<br/>&gt;&gt; responsibility to ensure the correct type).
<br/>&gt;&gt; Traverse(Decl* x) simply dispatches (i.e. forwards) to TraverseFoo(Foo* x)
<br/>&gt;&gt; where Foo is the dynamic type of *x. Traverse(Stmt* x) and Traverse(TypeLoc*
<br/>&gt;&gt; x) work similarly.
<br/>&gt;&gt; WalkUpFromFoo(Foo* x) (better name welcome) does task #2. It does not try to
<br/>&gt;&gt; visit any child of x. Instead, it first calls WalkUpFromBar(x) where Bar is
<br/>&gt;&gt; the direct parent class of Foo (unless Foo has no parent), and then calls
<br/>&gt;&gt; VisitFoo(x) (see the next bullet).
<br/>&gt;&gt; VisitFoo(Foo* x) does task #3.
<br/>&gt;&gt; 
<br/>&gt;&gt; Here's some pesudo code to show what these methods' implementation looks
<br/>&gt;&gt; like:
<br/>&gt;&gt; 
<br/>&gt;&gt; // A function returns false if it wants the traversal to abort (note that
<br/>&gt;&gt; // the current RecursiveASTVisitor class returns true for abortion - we
<br/>&gt;&gt; // feel that 'false' is much more intuitive).
<br/>&gt;&gt; 
<br/>&gt;&gt; // Therefore, each caller needs to check the return code and propagate
<br/>&gt;&gt; // it up appropriately. &nbsp;Such plumbing code is omitted here for clarify.
<br/>&gt;&gt; 
<br/>&gt;&gt; 
<br/>&gt;&gt; // The entry point for visiting an AST rooted at x.
<br/>&gt;&gt; bool Traverse(Decl* x) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; switch(x-&gt;getKind()) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; case kFoo:
<br/>&gt;&gt; &nbsp; &nbsp; TraverseFoo((Foo*)x);
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; &nbsp; break;
<br/>&gt;&gt; &nbsp; case kBar:
<br/>&gt;&gt; &nbsp; &nbsp; TraverseBar((Bar*)x);
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; &nbsp; break;
<br/>&gt;&gt; &nbsp; ...
<br/>&gt;&gt; &nbsp; }
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; 
<br/>&gt;&gt; bool TraverseFoo(Foo* x) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; WalkUpFromFoo(x);
<br/>&gt;&gt; &nbsp; for each child node n of x {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; &nbsp; Traverse(n)
<br/>&gt;&gt; &nbsp; }
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; 
<br/>&gt;&gt; bool WalkUpFromFoo(Foo* x) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; WalkUpFromBar(x); &nbsp;// Bar is Foo's parent.
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; VisitFoo(x);
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; bool WalkUpFromDecl(Decl* x) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; // Decl has no parent, so no more walking up.
<br/>&gt;&gt; &nbsp; VisitDecl(x);
<br/>&gt;&gt; 
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; // All Visit*() methods do nothing by default.
<br/>&gt;&gt; bool VisitFoo(Foo* x) { return true; }
<br/>&gt;&gt; 
<br/>&gt;&gt; Usually, a user shouldn't override a Traverse*() or WalkUpFrom*() function -
<br/>&gt;&gt; they are the &quot;skeleton&quot; of the AST visitor and do the mundane plumbing that
<br/>&gt;&gt; a normal user is not interested in. We recommend that only people truly
<br/>&gt;&gt; understand how the traversal works can override them.
<br/>&gt;&gt; 
<br/>&gt;&gt; A user is expected to override the Visit*() methods as needed. The default
<br/>&gt;&gt; implementation of them does nothing.
<br/>&gt;&gt; 
<br/>&gt;&gt; Returning a bool to indicate whether the traversal needs to be aborted
<br/>&gt;&gt; requires much tedious, error-prone plumbing in the implementation.
<br/>&gt;&gt; Exceptions are the most natural solution here, but unfortunately they are
<br/>&gt;&gt; banned from Clang code.
<br/>&gt;&gt; 
<br/>&gt;&gt; One advantage of this design over the existing RecursiveASTVisitor is that
<br/>&gt;&gt; when a user overrides VisitFoo(), he only needs to do what he's interested
<br/>&gt;&gt; in, without worrying about calling VisitFoo() or any other methods in the
<br/>&gt;&gt; base AST visitor class (so less chance to shoot his own feet).
<br/>&gt;&gt; 
<br/>&gt;&gt; With this design, all Visit*() methods on an AST ndoe are called before any
<br/>&gt;&gt; Visit*() method is called on a child node of it. &nbsp;So the trace of the
<br/>&gt;&gt; Visit*() calls is easy to understand and reason about.
<br/>&gt;&gt; 
<br/>&gt;&gt; One thing people might not like about the design is that it uses more
<br/>&gt;&gt; methods. I actually think it's a good thing that we have separate families
<br/>&gt;&gt; of methods for separate roles. RecursiveASTVisitor's approach of lumping all
<br/>&gt;&gt; logic (traversal, walking up the type hierarchy, and the custom visiting
<br/>&gt;&gt; logic) in the same Visit*() method makes the implementation more tricky and
<br/>&gt;&gt; error-prone - that's probably why there was so much confusion when we were
<br/>&gt;&gt; trying to improve RecursiveASTVisitor.
<br/>&gt;&gt; 
<br/>&gt;&gt; To ensure performance, we would use CRTP as the existing AST visitors do.
<br/>&gt;&gt; That means two things:
<br/>&gt;&gt; 
<br/>&gt;&gt; No need for virtual functions.
<br/>&gt;&gt; The entire code is templated s.t. the compiler can easily inline trivial
<br/>&gt;&gt; functions and do cross-function optimization.
<br/>&gt;&gt; 
<br/>&gt;&gt; Use Cases
<br/>&gt;&gt; 
<br/>&gt;&gt; Let's see how some typical use cases can be implemented using our AST
<br/>&gt;&gt; visitor.
<br/>&gt;&gt; 
<br/>&gt;&gt; Dump the AST
<br/>&gt;&gt; 
<br/>&gt;&gt; Only 3 methods need to be overridden:
<br/>&gt;&gt; 
<br/>&gt;&gt; VisitDecl(Decl* x) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; print information about x;
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; VisitStmt(Stmt* x) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; print information about x;
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; VisitTypeLoc(TypeLoc* x) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; print information about x;
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; Search for an AST Node of Type Foo
<br/>&gt;&gt; 
<br/>&gt;&gt; The tool would override VisitFoo(Foo* x) to return false if x is the node
<br/>&gt;&gt; it's looking for.
<br/>&gt;&gt; 
<br/>&gt;&gt; Find the Parents of an AST Node
<br/>&gt;&gt; 
<br/>&gt;&gt; The tool would maintain a stack of the nodes that lead to the current node.
<br/>&gt;&gt; It can build the stack by overriding exactly 3 methods (plumbing of the
<br/>&gt;&gt; return code omitted):
<br/>&gt;&gt; 
<br/>&gt;&gt; Traverse(Decl* d) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; Push(d);
<br/>&gt;&gt; &nbsp; Base::Traverse(d);
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; Pop();
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; Traverse(Stmt* s) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; Push(s);
<br/>&gt;&gt; &nbsp; Base::Traverse(s);
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; Pop();
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; Traverse(TypeLoc* t) {
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; Push(t);
<br/>&gt;&gt; &nbsp; Base::Traverse(t);
<br/>&gt;&gt; 
<br/>&gt;&gt; &nbsp; Pop();
<br/>&gt;&gt; }
<br/>&gt;&gt; 
<br/>&gt;&gt; --
<br/>&gt;&gt; Zhanyong
<br/>&gt;&gt; 
<br/>&gt;&gt; 
<br/>&gt; 
<br/>&gt; 
<br/>&gt; 
<br/>&gt; -- 
<br/>&gt; Zhanyong
</div><br/><br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=880947&i=1" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			
				</td>
			</tr>
		</table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960">Zhanyong Wan (λx.x x)</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="/template/NamlServlet.jtp?macro=reply&amp;node=881581" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView('threaded', '/new-design-of-RecursiveASTVisitor-tt871799.html#a881581',881581)">Threaded</a>
	<div id="tooltip12253" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip12253'), 'up', 400);
	</script> |
					<span id="dd_postdropdown881581"></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown881581", "More","Click for more options");
		
		dropdown.add('replyToAuthor881581', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D881581\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost881581', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D881581\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost881581', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D881581\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost881581', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(881581)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively881581', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(881581)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate881581', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D881581\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print881581', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D881581\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink881581', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://clang-developers.42468.n3.nabble.com/new-design-of-RecursiveASTVisitor-tp871799p881581.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail881581', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D881581\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown881581');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=881581' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="/images/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(881581)"/>
	<div id="tooltip78079" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">&diams;</div>
			<div class="d2">&diams;</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip78079'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow881581" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="/images/arrow.png" alt="Selected post"/>
	</span>
					<span class="post-date float-left">
		<span id="d1276068721000-212"></span><script type="text/javascript">
		Nabble.get('d1276068721000-212').innerHTML= Nabble.formatDateLong(new Date(1276068721000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit">
		Re: new design of RecursiveASTVisitor
	</h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://clang-developers.42468.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&amp;user=12960" rel="nofollow" title="View profile of Zhanyong Wan (λx.x x)" class="nowrap no-decoration"><img class="avatar medium-border-color" src="http://www.gravatar.com/avatar/77efdc542a2e6f7a356c42031ed41a9f?s=100&amp;r=pg&amp;d=http%3A%2F%2Fn3.nabble.com%2Fimages%2Favatar100.png" height="100" width="100" alt="Zhanyong Wan (λx.x x)" title="Zhanyong Wan (λx.x x)"/><img src="/images/online.png" class="online12960 online invisible" title="User is online" alt="online"/></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count12960 avatar-label weak-color"></div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message881581" class="message-text adbayes-content">
		Thanks for the excellent comments, Doug and Chandler! &nbsp;I've uploaded a
<br/>new patch to the codereview app.
<br/><br/>On Tue, Jun 8, 2010 at 5:33 PM, Douglas Gregor &lt;<a href="/user/SendEmail.jtp?type=node&node=881581&i=0" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt; wrote:
<div class='shrinkable-quote'><br/>&gt;
<br/>&gt; On Jun 8, 2010, at 2:44 PM, Zhanyong Wan (λx.x x) wrote:
<br/>&gt;
<br/>&gt;&gt; Hi, all,
<br/>&gt;&gt;
<br/>&gt;&gt; Craig and I implemented most of the new design.  I uploaded the patch
<br/>&gt;&gt; to <a href="http://codereview.appspot.com/1607042" target="_top" rel="nofollow" link="external">http://codereview.appspot.com/1607042</a>&nbsp;for easy reviewing - you can
<br/>&gt;&gt; download it from
<br/>&gt;&gt; <a href="http://codereview.appspot.com/download/issue1607042_1.diff" target="_top" rel="nofollow" link="external">http://codereview.appspot.com/download/issue1607042_1.diff</a><br/>&gt;&gt;
<br/>&gt;&gt; In the implementation we made a slight change to the proposed design:
<br/>&gt;&gt; instead of overloading Traverse() for Stmt, Type, and Decl, we prefer
<br/>&gt;&gt; to have separate TraverseStmt, TraverseType, and TraverseDecl
<br/>&gt;&gt; functions.  We think that makes the code clearer.
<br/>&gt;&gt;
<br/>&gt;&gt; Chandler plan to review it after 3pm today.  Doug, would you have some
<br/>&gt;&gt; time to look at this today?  Thanks!
<br/>&gt;
<br/>&gt; I've added my comments up on codereview.appspot.com. Looks good!
<br/>&gt;
<br/>&gt;        - Doug
<br/>&gt;
<br/>&gt;&gt; On Fri, Jun 4, 2010 at 4:35 PM, Zhanyong Wan (λx.x x) &lt;<a href="/user/SendEmail.jtp?type=node&node=881581&i=1" target="_top" rel="nofollow" link="external">[hidden email]</a>&gt; wrote:
<br/>&gt;&gt;&gt; Hi,
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; While working on improving the RecursiveASTVisitor class, some of us saw an
<br/>&gt;&gt;&gt; opportunity for a different design that's cleaner and easier to understand
<br/>&gt;&gt;&gt; and use.  Here's the proposal.  Comments and suggestions welcome!
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Clang AST Visitor Design
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; This document discusses the design of a customizable visitor class for the
<br/>&gt;&gt;&gt; AST generated by the Clang C++ parser.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Background
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Clang comes with two AST visitor classes: ASTVisitor and
<br/>&gt;&gt;&gt; RecursiveASTVisitor. The ideas behind the two are similar. Both are
<br/>&gt;&gt;&gt; implemented using the CRTP pattern. The former is considered an internal
<br/>&gt;&gt;&gt; class and not for use in tools developed on top of Clang. The latter is
<br/>&gt;&gt;&gt; supposed to be a public API.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; At this time, neither class is complete (i.e. they'll miss some AST nodes)
<br/>&gt;&gt;&gt; and there are known bugs (e.g. some AST nodes may be visited more than
<br/>&gt;&gt;&gt; once). We are working on improving RecursiveASTVisitor. Our experience shows
<br/>&gt;&gt;&gt; that its design has much space for improvement. Therefore it would be a
<br/>&gt;&gt;&gt; worthwhile exercise to see what we can come up with if we do it from
<br/>&gt;&gt;&gt; scratch, without being constrained or influenced by the current
<br/>&gt;&gt;&gt; RecursiveASTVisitor design.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Concepts and Terminology
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Muddy concepts lead to poor, confusing designs. Before we explore the design
<br/>&gt;&gt;&gt; space, it's important to clarify some key concepts.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; An AST is a tree-shaped data structure. A node in an AST can have 0 or many
<br/>&gt;&gt;&gt; other nodes as its children.
<br/>&gt;&gt;&gt; There a three categories of AST nodes in Clang: statements,
<br/>&gt;&gt;&gt; declarations/definitions, and types. They are derived from class Stmt, Decl,
<br/>&gt;&gt;&gt; and TypeLoc, respectively. In general, a node may have children of any or
<br/>&gt;&gt;&gt; all of the three categories. The class hierarchies for Stmt, Decl, and
<br/>&gt;&gt;&gt; TypeLoc can be found here.
<br/>&gt;&gt;&gt; The AST visitor has three distinct tasks:
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; traverse the entire AST (i.e. go to every node),
<br/>&gt;&gt;&gt; at each node, walk up the class hierarchy, starting with the dynamic type of
<br/>&gt;&gt;&gt; the node,
<br/>&gt;&gt;&gt; for a given (node, type) combination (where 'type' is some base class of the
<br/>&gt;&gt;&gt; dynamic type of 'node'), call a user-overridable function to actually
<br/>&gt;&gt;&gt; &quot;visit&quot; the node.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Design Goals
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; easy-to-understand API
<br/>&gt;&gt;&gt; performs a depth-first, preorder traversal on the AST (no child of a node
<br/>&gt;&gt;&gt; can be visited until all work on the node has been done)
<br/>&gt;&gt;&gt; complete coverage: each node in the AST must be visited
<br/>&gt;&gt;&gt; no duplication: a node cannot be visited more than once
<br/>&gt;&gt;&gt; common use cases should be easy
<br/>&gt;&gt;&gt; fast
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Our Design
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; The distinction between the AST visitor's three tasks (see the &quot;Concepts and
<br/>&gt;&gt;&gt; Terminology&quot; section above) is important for understanding how the AST
<br/>&gt;&gt;&gt; visitor works and using it effectively. Therefore we use naming conventions
<br/>&gt;&gt;&gt; to highlight the role of a method of the AST visitor:
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; TraverseFoo(Foo* x) does task #1. It traveses (i.e. recursively visits) the
<br/>&gt;&gt;&gt; sub-tree rooted at x, where Foo is *x's dynamic type (it's the caller's
<br/>&gt;&gt;&gt; responsibility to ensure the correct type).
<br/>&gt;&gt;&gt; Traverse(Decl* x) simply dispatches (i.e. forwards) to TraverseFoo(Foo* x)
<br/>&gt;&gt;&gt; where Foo is the dynamic type of *x. Traverse(Stmt* x) and Traverse(TypeLoc*
<br/>&gt;&gt;&gt; x) work similarly.
<br/>&gt;&gt;&gt; WalkUpFromFoo(Foo* x) (better name welcome) does task #2. It does not try to
<br/>&gt;&gt;&gt; visit any child of x. Instead, it first calls WalkUpFromBar(x) where Bar is
<br/>&gt;&gt;&gt; the direct parent class of Foo (unless Foo has no parent), and then calls
<br/>&gt;&gt;&gt; VisitFoo(x) (see the next bullet).
<br/>&gt;&gt;&gt; VisitFoo(Foo* x) does task #3.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Here's some pesudo code to show what these methods' implementation looks
<br/>&gt;&gt;&gt; like:
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; // A function returns false if it wants the traversal to abort (note that
<br/>&gt;&gt;&gt; // the current RecursiveASTVisitor class returns true for abortion - we
<br/>&gt;&gt;&gt; // feel that 'false' is much more intuitive).
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; // Therefore, each caller needs to check the return code and propagate
<br/>&gt;&gt;&gt; // it up appropriately.  Such plumbing code is omitted here for clarify.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; // The entry point for visiting an AST rooted at x.
<br/>&gt;&gt;&gt; bool Traverse(Decl* x) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   switch(x-&gt;getKind()) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   case kFoo:
<br/>&gt;&gt;&gt;     TraverseFoo((Foo*)x);
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;     break;
<br/>&gt;&gt;&gt;   case kBar:
<br/>&gt;&gt;&gt;     TraverseBar((Bar*)x);
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;     break;
<br/>&gt;&gt;&gt;   ...
<br/>&gt;&gt;&gt;   }
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; bool TraverseFoo(Foo* x) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   WalkUpFromFoo(x);
<br/>&gt;&gt;&gt;   for each child node n of x {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;     Traverse(n)
<br/>&gt;&gt;&gt;   }
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; bool WalkUpFromFoo(Foo* x) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   WalkUpFromBar(x);  // Bar is Foo's parent.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   VisitFoo(x);
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; bool WalkUpFromDecl(Decl* x) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   // Decl has no parent, so no more walking up.
<br/>&gt;&gt;&gt;   VisitDecl(x);
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; // All Visit*() methods do nothing by default.
<br/>&gt;&gt;&gt; bool VisitFoo(Foo* x) { return true; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Usually, a user shouldn't override a Traverse*() or WalkUpFrom*() function -
<br/>&gt;&gt;&gt; they are the &quot;skeleton&quot; of the AST visitor and do the mundane plumbing that
<br/>&gt;&gt;&gt; a normal user is not interested in. We recommend that only people truly
<br/>&gt;&gt;&gt; understand how the traversal works can override them.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; A user is expected to override the Visit*() methods as needed. The default
<br/>&gt;&gt;&gt; implementation of them does nothing.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Returning a bool to indicate whether the traversal needs to be aborted
<br/>&gt;&gt;&gt; requires much tedious, error-prone plumbing in the implementation.
<br/>&gt;&gt;&gt; Exceptions are the most natural solution here, but unfortunately they are
<br/>&gt;&gt;&gt; banned from Clang code.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; One advantage of this design over the existing RecursiveASTVisitor is that
<br/>&gt;&gt;&gt; when a user overrides VisitFoo(), he only needs to do what he's interested
<br/>&gt;&gt;&gt; in, without worrying about calling VisitFoo() or any other methods in the
<br/>&gt;&gt;&gt; base AST visitor class (so less chance to shoot his own feet).
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; With this design, all Visit*() methods on an AST ndoe are called before any
<br/>&gt;&gt;&gt; Visit*() method is called on a child node of it.  So the trace of the
<br/>&gt;&gt;&gt; Visit*() calls is easy to understand and reason about.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; One thing people might not like about the design is that it uses more
<br/>&gt;&gt;&gt; methods. I actually think it's a good thing that we have separate families
<br/>&gt;&gt;&gt; of methods for separate roles. RecursiveASTVisitor's approach of lumping all
<br/>&gt;&gt;&gt; logic (traversal, walking up the type hierarchy, and the custom visiting
<br/>&gt;&gt;&gt; logic) in the same Visit*() method makes the implementation more tricky and
<br/>&gt;&gt;&gt; error-prone - that's probably why there was so much confusion when we were
<br/>&gt;&gt;&gt; trying to improve RecursiveASTVisitor.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; To ensure performance, we would use CRTP as the existing AST visitors do.
<br/>&gt;&gt;&gt; That means two things:
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; No need for virtual functions.
<br/>&gt;&gt;&gt; The entire code is templated s.t. the compiler can easily inline trivial
<br/>&gt;&gt;&gt; functions and do cross-function optimization.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Use Cases
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Let's see how some typical use cases can be implemented using our AST
<br/>&gt;&gt;&gt; visitor.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Dump the AST
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Only 3 methods need to be overridden:
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; VisitDecl(Decl* x) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   print information about x;
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; VisitStmt(Stmt* x) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   print information about x;
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; VisitTypeLoc(TypeLoc* x) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   print information about x;
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Search for an AST Node of Type Foo
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; The tool would override VisitFoo(Foo* x) to return false if x is the node
<br/>&gt;&gt;&gt; it's looking for.
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Find the Parents of an AST Node
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; The tool would maintain a stack of the nodes that lead to the current node.
<br/>&gt;&gt;&gt; It can build the stack by overriding exactly 3 methods (plumbing of the
<br/>&gt;&gt;&gt; return code omitted):
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Traverse(Decl* d) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   Push(d);
<br/>&gt;&gt;&gt;   Base::Traverse(d);
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   Pop();
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Traverse(Stmt* s) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   Push(s);
<br/>&gt;&gt;&gt;   Base::Traverse(s);
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   Pop();
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; Traverse(TypeLoc* t) {
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   Push(t);
<br/>&gt;&gt;&gt;   Base::Traverse(t);
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;   Pop();
<br/>&gt;&gt;&gt; }
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt; --
<br/>&gt;&gt;&gt; Zhanyong
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;&gt;
<br/>&gt;&gt;
<br/>&gt;&gt;
<br/>&gt;&gt;
<br/>&gt;&gt; --
<br/>&gt;&gt; Zhanyong
<br/>&gt;
<br/>&gt;
</div><br/><br/><br/>-- 
<br/>Zhanyong
<br/><br/>_______________________________________________
<br/>cfe-dev mailing list
<br/><a href="/user/SendEmail.jtp?type=node&node=881581&i=2" target="_top" rel="nofollow" link="external">[hidden email]</a>
<br/><a href="http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev" target="_top" rel="nofollow" link="external">http://lists.cs.uiuc.edu/mailman/listinfo/cfe-dev</a><br/>

	
	
	
	</div>
	
			<script type="text/javascript">
				Nabble.ads('last_classic_message');
			</script>
				</td>
			</tr>
		</table>
	</div>
	
		
	</div>
	</div>
			<div id="topic-footer" class="weak-color" style="padding-top:1em">
		&laquo;
		<a href="http://clang-developers.42468.n3.nabble.com/">Return to Clang Developers</a>
		&nbsp;|&nbsp;
		<span id="v871799" style="display:none">1 view|%1 views</span>
	
	
	</div>
			<div id="report-inappropriate-content" class="report-inappropriate-content rounded">
		<div id="report-inappropriate-content-inner" class="no-bg-color medium-border-color border2">
			<div class="big">Loading...</div>
		</div>
	</div>
				<script type="text/javascript">
				Nabble.ads('topic_bottom');
			</script>
			<table class="footer-table shaded-bg-color">
		<tr>
			<td class="footer-left weak-color">
				<a href="http://www.nabble.com/" target="_top">Free forum by Nabble</a>
			</td>
			<td class="footer-right">
				<a href="/template/NamlServlet.jtp?macro=macro_viewer&amp;id=classic_forum_topic%21nabble%3Atopic.naml&amp;base=nabble.view.web.template.ServletNamespace" rel="nofollow">Edit this page</a>
			</td>
		</tr>
	</table>
			<script type='text/javascript'>
var scriptUrl = '/template/NamlServlet.jtp?macro=js_page&searchSpecial=871799&incViewCount=871799&newsflash=&visitorOnline=&avatarOnline=12960|14308|60154|8571|8574&postCount=12960|14308|60154|8571|8574&markVisited=881581&views=871799';
scriptUrl += '&_=' + Math.floor(Math.random()*9999) + Nabble.getClientID();
$.getScript(scriptUrl, function() { Nabble.resizeFrames(); });
</script>

					</div>
					<!-- Ad.true | 0 credits -->
	<script type="text/javascript">
		Nabble.trk = Nabble.trk || {};
		Nabble.trk.safe = true;
	</script>
	<script type="text/javascript">
		$(document).ready(function() { Nabble.fixCookieClientID(); });
		(function(){ var sNew = document.createElement("script"); sNew.defer = true; sNew.src = "http://tag.crsspxl.com/s1.js?d=1294"; var s0 = document.getElementsByTagName('script')[0]; s0.parentNode.insertBefore(sNew, s0); })();
		Nabble.trk = Nabble.trk || {};
		Nabble.trk.ours = false;
		Nabble.trk.host = 'n3.nabble.com';
	</script>
	<script src="http://static.nabble.com/trk0.js?7808" type="text/javascript"></script>
					<!-- n3.nabble.com | Site ID = 42468 -->
				</body>
			</html>